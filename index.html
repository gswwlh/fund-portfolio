<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂÆöÊäïÁ≥ªÁªü (V7 ‰∫ëÁ´ØÁâà)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --primary: #1890ff;       
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e8e8e8;
            
            /* ËØ≠‰πâËâ≤ */
            --pos: #ff4d4f; /* Ê∂®/‰π∞ÂÖ•/Ë∂ÖÈÖç */
            --neg: #52c41a; /* Ë∑å/ÂçñÂá∫/‰ΩéÈÖç */
            --warn: #faad14; 
            
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* --- 1. È°∂ÈÉ®Ê∑±ËìùÊåáÊå•Ëà± --- */
        .dashboard-config {
            background: #1867c0;
            color: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(24, 103, 192, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .config-group { display: flex; gap: 30px; align-items: center; }
        .config-item label { display: block; font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
        
        .dash-input {
            background: white; border: none; color: #333;
            padding: 10px 15px; border-radius: 6px; font-size: 20px; font-weight: bold;
            width: 180px; font-family: 'Consolas', monospace;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .dash-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        .summary-group { display: flex; gap: 40px; text-align: right; }
        .summary-label { font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; }
        .summary-val { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: -0.5px; line-height: 1.2;}
        .summary-sub { font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px;}
        .btn-dash {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-dash:hover { background: rgba(255,255,255,0.3); }
        .btn-toggle-active { background: #fff !important; color: #1867c0 !important; font-weight: bold; }

        /* --- 2. ËµÑ‰∫ßÂàÜÊûêÁúãÊùø (ÈªòËÆ§ÈöêËóè) --- */
        .analysis-dashboard {
            display: none; 
            grid-template-columns: 400px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch; 
        }
        @media (max-width: 900px) { .analysis-dashboard { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 20px; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 320px;
        }
        .chart-container-inner { width: 100%; height: 100%; max-height: 300px; position: relative; }

        .rebalance-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;
        }
        .rb-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #333; }
        
        .rb-table { width: 100%; border-collapse: collapse; font-size: 14px; flex: 1; }
        .rb-table th { text-align: left; padding: 12px 10px; background: #fafafa; color: #888; font-weight: 600; border-bottom: 1px solid #eee; }
        .rb-table td { padding: 14px 10px; border-bottom: 1px solid #f5f5f5; color: #333; font-weight: 500; }
        .rb-table tr:last-child td { border-bottom: none; }
        
        .tag-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 800; }
        .st-over { background: #fff1f0; color: var(--pos); border: 1px solid #ffa39e; }
        .st-under { background: #fffbe6; color: var(--warn); border: 1px solid #ffe58f; }
        .st-ok { background: #f6ffed; color: var(--neg); border: 1px solid #b7eb8f; }

        .rb-action { font-family: 'Consolas', monospace; font-weight: 800; font-size: 15px;}
        .act-sell { color: var(--neg); } 
        .act-buy { color: var(--pos); }  
        
        .rb-tip { margin-top: 15px; padding-top: 15px; font-size: 12px; color: #999; border-top: 1px dashed #eee; line-height: 1.6; }

        /* --- 3. Â§çÂà©ËÆ°ÁÆóÂô®Ê®°Âùó (Êñ∞Â¢û) --- */
        .compound-dashboard {
            display: none; /* ÈªòËÆ§ÈöêËóè */
            grid-template-columns: 350px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }
        @media (max-width: 900px) { .compound-dashboard { grid-template-columns: 1fr; } }

        .compound-inputs {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; gap: 20px;
        }
        .cp-title { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 5px; }
        
        .input-row label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .input-row input { 
            width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;
            font-size: 16px; font-weight: bold; box-sizing: border-box;
        }
        .input-row input:focus { border-color: var(--primary); outline: none; }

        .result-box {
            background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; margin-top: 10px;
        }
        .res-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .res-val { font-size: 24px; font-weight: 800; margin-top: 2px; }
        .res-val.type-a { color: #faad14; } /* Ê©ôËâ≤ - ‰∏ÄÊ¨°ÊÄß */
        .res-val.type-b { color: #1890ff; } /* ËìùËâ≤ - ÂÆöÊäï */

        /* --- ‰ªäÊó•Áõà‰∫èÊ®°Âùó --- */
        .daily-pnl-dashboard {
            display: block;
            margin-bottom: 15px;
        }

        /* ÂÆûÊó∂È¢Ñ‰º∞ÈªòËÆ§ÈöêËóè */
        #estimatePanel {
            display: none;
        }

        .pnl-card {
            background: #1867c0;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(24, 103, 192, 0.2);
            padding: 20px 30px;
        }

        .pnl-header {
            color: white;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pnl-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .pnl-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .pnl-summary-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pnl-label {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .pnl-value {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: white;
            line-height: 1;
        }

        .pnl-count {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-count.profit {
            color: #ff4d4f;
        }

        .pnl-count.loss {
            color: #52c41a;
        }

        .pnl-count-total {
            font-size: 32px;
            font-weight: 800;
            color: white;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-value-large {
            font-size: 28px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #fff;
            line-height: 1;
        }

        .pnl-rate {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: rgba(255,255,255,0.9);
            margin-top: 5px;
        }

        .pnl-loading {
            padding: 60px;
            text-align: center;
            color: rgba(255,255,255,0.8);
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pnl-content {
            padding: 0;
            margin-top: 15px;
            background: transparent;
        }

        .pnl-sector {
            border-top: 5px solid #ccc;
            margin-bottom: 15px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            background: white;
        }

        .pnl-sector:last-child {
            margin-bottom: 0;
        }

        .pnl-sector-header {
            background: #fafafa;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }

        .pnl-sector-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pnl-sector-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .pnl-sector-stat {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .pnl-sector-total {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-sector-asset {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: #333;
            line-height: 1;
        }

        .pnl-sector-rate {
            font-size: 13px;
            font-weight: 600;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .pnl-table th {
            background: #f9f9f9;
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            color: #888;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .pnl-table th:nth-child(1) { width: 10%; } /* Âü∫Èáë‰ª£Á†Å */
        .pnl-table th:nth-child(2) { width: 25%; } /* Âü∫ÈáëÂêçÁß∞ */
        .pnl-table th:nth-child(3) { width: 12%; } /* Âçï‰ΩçÂáÄÂÄº */
        .pnl-table th:nth-child(4) { width: 12%; } /* Êó•Ê∂®ÂπÖ */
        .pnl-table th:nth-child(5) { width: 15%; } /* ÊåÅ‰ªì‰ªΩÈ¢ù */
        .pnl-table th:nth-child(6) { width: 16%; text-align: right; } /* ‰ªäÊó•Êî∂Áõä */

        .pnl-table td:nth-child(1) { width: 10%; }
        .pnl-table td:nth-child(2) { width: 25%; }
        .pnl-table td:nth-child(3) { width: 12%; }
        .pnl-table td:nth-child(4) { width: 12%; }
        .pnl-table td:nth-child(5) { width: 15%; }
        .pnl-table td:nth-child(6) { width: 16%; text-align: right; }

        .pnl-table td {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 14px;
            color: #333;
        }

        .pnl-table tr:last-child td {
            border-bottom: none;
        }

        .pnl-table tr:hover {
            background: #fafafa;
        }

        .fund-code {
            font-family: 'Consolas', monospace;
            color: #666;
            font-size: 13px;
        }

        .fund-name {
            font-weight: 600;
            color: #333;
        }

        .nav-value {
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }

        .growth-rate {
            font-family: 'Consolas', monospace;
            font-weight: 700;
            font-size: 15px;
        }

        .growth-positive {
            color: #ff4d4f;
        }

        .growth-negative {
            color: #52c41a;
        }

        .growth-zero {
            color: #999;
        }

        .share-amount {
            font-family: 'Consolas', monospace;
            color: #666;
        }

        .daily-profit {
            font-family: 'Consolas', monospace;
            font-weight: 800;
            font-size: 16px;
        }

        .profit-positive {
            color: #ff4d4f;
        }

        .profit-negative {
            color: #52c41a;
        }

        .profit-zero {
            color: #999;
        }

        /* ÊâãÊú∫Á´ØÂç°ÁâáÂºèÂ∏ÉÂ±Ä */
        .pnl-mobile-list {
            display: none;
        }

        .pnl-mobile-item {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .pnl-mobile-item:last-child {
            border-bottom: none;
        }

        /* ÁßªÂä®Á´ØÈªëËâ≤‰∏ªÈ¢òË¶ÜÁõñ */
        @media (max-width: 768px) {
            .pnl-mobile-item {
                background: rgba(255, 255, 255, 0.03);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
        }

        .pnl-mobile-header {
            margin-bottom: 12px;
        }

        .pnl-mobile-fund-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pnl-mobile-fund-name {
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        .pnl-mobile-fund-code {
            font-size: 12px;
            color: #999;
        }

        .pnl-mobile-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .pnl-mobile-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .pnl-mobile-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .pnl-mobile-value {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #333;
            line-height: 1.2;
        }

        /* ÁßªÂä®Á´ØÈªëËâ≤‰∏ªÈ¢òË¶ÜÁõñ - Âç°ÁâáÊñáÂ≠ó */
        @media (max-width: 768px) {
            .pnl-mobile-fund-name {
                color: #e8eaf0;
            }
            
            .pnl-mobile-fund-code {
                color: rgba(255, 255, 255, 0.5);
            }
            
            .pnl-mobile-label {
                color: rgba(255, 255, 255, 0.6);
            }
            
            .pnl-mobile-value {
                color: #ffffff;
            }
        }

        .pnl-mobile-sub {
            font-size: 13px;
            font-weight: 600;
            font-family: 'Consolas', monospace;
            margin-top: 2px;
        }

        /* --- 4. ÊùøÂùóÂç°Áâá --- */
        .sector-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border-top: 5px solid #ccc;
            position: relative;
        }
        
        .card-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .sector-name-input { font-size: 18px; font-weight: 800; color: #333; border: 1px solid transparent; background: transparent; width: 260px; padding: 4px; border-radius: 4px; }
        .sector-name-input:hover { border-color: #eee; }
        .sector-name-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        .strategy-tag { font-size: 12px; padding: 3px 8px; border-radius: 10px; background: #f5f5f5; color: #666; border: 1px solid #e8e8e8; cursor: pointer; }

        .header-right { display: flex; align-items: center; gap: 15px; background: #f9f9f9; padding: 8px 15px; border-radius: 6px; }
        .ratio-label { font-size: 13px; color: #666; }
        .ratio-input { width: 40px; text-align: center; border: 1px solid #d9d9d9; padding: 4px; border-radius: 4px; font-weight: bold; color: #333; background: #fff; }
        .ratio-input:focus { border-color: var(--primary); outline: none; }
        
        .progress-mini { font-size: 12px; color: #999; margin-left: 10px; }

        .tool-bar { display: flex; gap: 5px; margin-right: 10px; }
        .color-picker { width: 20px; height: 20px; padding: 0; border: none; cursor: pointer; background: none; vertical-align: middle; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 16px; color: #ccc; }
        .btn-icon:hover { color: #ff4d4f; }

        .table-wrap { padding: 10px 25px 25px 25px; }
        table { width: 100%; border-collapse: collapse; }
        
        .fund-table th { text-align: left; padding: 12px 10px; font-size: 12px; color: #888; font-weight: normal; border-bottom: 1px dashed #eee; }
        .fund-table td { padding: 15px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; font-size: 14px; }
        .fund-table tr:last-child td { border-bottom: none; }
        
        .tb-input { width: 100%; padding: 8px 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 14px; color: #333; transition: all 0.2s; box-sizing: border-box; }
        .tb-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); }
        .tb-sm { width: 60px; text-align: center; }

        .result-pill { display: block; padding: 8px 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: 700; font-size: 16px; text-align: right; background: #e6f7ff; color: #1890ff; min-width: 90px; }
        .res-stop { background: #f5f5f5; color: #ccc; font-weight: normal; }
        
        .val-display { font-weight: bold; font-family: 'Consolas', monospace; color: #333; }
        .pf-pos { color: var(--pos); font-size: 12px; }
        .pf-neg { color: var(--neg); font-size: 12px; }

        .btn-add-fund { width: 100%; padding: 12px; border: 1px dashed #d9d9d9; background: #fafafa; color: #666; cursor: pointer; border-radius: 0 0 var(--radius) var(--radius); font-size: 13px; transition: 0.2s; }
        .btn-add-fund:hover { color: var(--primary); border-color: var(--primary); background: #fff; }

        .btn-add-sector { width: 100%; padding: 20px; border: 2px dashed #d9d9d9; border-radius: var(--radius); background: transparent; color: #999; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 40px; transition: 0.2s; }
        .btn-add-sector:hover { border-color: var(--primary); color: var(--primary); background: #f0faff; }

        .warning-box { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; padding: 12px; text-align: center; margin-bottom: 20px; border-radius: var(--radius); font-weight: 600; display: none; }
        
        /* ËÅîÁΩëÂäüËÉΩÊ†∑Âºè */
        .sync-status { display: inline-block; margin-left: 10px; font-size: 12px; padding: 3px 8px; border-radius: 4px; }
        .sync-success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .sync-error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .sync-loading { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }

        /* --- 5. Â∫ïÈÉ®Á≠ñÁï•Âç°Áâá --- */
        .strategy-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 40px; margin-bottom: 40px; }
        @media (max-width: 768px) { .strategy-footer { grid-template-columns: 1fr; } }

        .info-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #eee; }
        .info-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; }
        .strategy-list, .rules-list { padding-left: 0; list-style: none; margin: 0; }
        .strategy-list li, .rules-list li { margin-bottom: 15px; color: var(--text-sub); font-size: 14px; line-height: 1.6; }
        .strategy-list li strong, .rules-list li strong { color: #333; }
        
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .green { background: #52c41a; }
        .yellow { background: #faad14; }
        .red { background: #ff4d4f; }
        
        .highlight-text { color: #1890ff; font-weight: bold; background: #e6f7ff; padding: 2px 4px; border-radius: 4px; }

        /* --- ÊåáÊï∞Èù¢ÊùøÊ†∑Âºè --- */
        .index-dashboard {
            background: #1867c0;
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(24, 103, 192, 0.2);
        }

        .index-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .index-title span {
            flex: 0 0 auto;
        }

        .index-title button:first-of-type {
            margin-left: auto;
        }

        .index-refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .index-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .index-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        @media (max-width: 1024px) {
            .index-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .index-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .index-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .index-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .index-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .index-value {
            color: white;
            font-size: 22px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            margin-bottom: 5px;
        }

        .index-change {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }

        .index-change.positive {
            color: #ff6b6b;
        }

        .index-change.negative {
            color: #51cf66;
        }

        .index-change.zero {
            color: rgba(255, 255, 255, 0.7);
        }

        /* ÁßªÂä®Á´ØÈªëËâ≤‰∏ªÈ¢ò - Ê∂®Ë∑åÈ¢úËâ≤Â¢ûÂº∫ */
        @media (max-width: 768px) {
            .index-change.positive {
                color: #ff5757;
                text-shadow: 0 0 8px rgba(255, 87, 87, 0.3);
            }

            .index-change.negative {
                color: #51cf66;
                text-shadow: 0 0 8px rgba(81, 207, 102, 0.3);
            }
            
            .growth-positive,
            .profit-positive {
                color: #ff5757 !important;
            }
            
            .growth-negative,
            .profit-negative {
                color: #51cf66 !important;
            }
            
            .pnl-mobile-sub {
                font-weight: 600;
            }
        }

        /* --- Áî®Êà∑IDÁÆ°ÁêÜÂºπÁ™ó --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 800;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .modal-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-value {
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #1890ff;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #d9d9d9;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-input:focus {
            border-color: #1890ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #1890ff;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #40a9ff;
        }

        .modal-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        .modal-btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .modal-btn-danger:hover {
            background: #ff7875;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #40a9ff;
        }

        .modal-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* ========== ÁßªÂä®Á´Ø‰ºòÂåñ ========== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                background: #0a0e1a;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            /* È°∂ÈÉ®ÈÖçÁΩÆÈù¢Êùø */
            .dashboard-config {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .config-group {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .config-item {
                width: 100%;
            }

            .dash-input {
                width: 100%;
                font-size: 16px;
                padding: 12px;
            }

            .summary-group {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .summary-item {
                text-align: left;
            }

            .summary-val {
                font-size: 24px;
            }

            /* ÊåâÈíÆÁªÑ */
            .btn-group {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn-dash {
                font-size: 11px;
                padding: 8px 10px;
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
            }

            /* ÊåáÊï∞Èù¢Êùø */
            .index-dashboard {
                padding: 20px 15px;
                margin-bottom: 15px;
                border-radius: 12px;
                background: linear-gradient(135deg, #1a1f35 0%, #2d1b3d 100%);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .index-title {
                font-size: 16px;
                margin-bottom: 15px;
                font-weight: 700;
                color: #e8eaf0;
            }

            .index-refresh-btn {
                font-size: 12px;
                padding: 5px 10px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #e8eaf0;
            }

            .index-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .index-item {
                padding: 12px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                transition: all 0.3s ease;
            }
            
            .index-item:active {
                transform: scale(0.98);
                background: rgba(255, 255, 255, 0.12);
            }

            .index-name {
                font-size: 12px;
                margin-bottom: 6px;
                color: rgba(255, 255, 255, 0.7);
            }

            .index-value {
                font-size: 20px;
                margin-bottom: 4px;
                font-weight: 700;
                color: #ffffff;
            }

            .index-change {
                font-size: 13px;
                font-weight: 600;
            }

            /* ‰ªäÊó•Áõà‰∫èÈù¢Êùø */
            .daily-pnl-dashboard {
                margin-bottom: 15px;
            }

            .pnl-card {
                border-radius: 12px;
                padding: 15px;
                background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .pnl-header {
                margin-bottom: 15px;
            }

            .pnl-title {
                font-size: 16px;
                font-weight: 700;
                color: #e8eaf0;
            }

            .pnl-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .pnl-summary-item {
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                transition: all 0.3s ease;
            }
            
            .pnl-summary-item:active {
                transform: scale(0.98);
                background: rgba(255, 255, 255, 0.12);
            }

            .pnl-label {
                font-size: 11px;
                margin-bottom: 6px;
                color: rgba(255, 255, 255, 0.6);
            }

            .pnl-value,
            .pnl-count,
            .pnl-count-total {
                font-size: 24px;
                color: #ffffff;
            }

            .pnl-value-large {
                font-size: 22px;
                color: #ffffff;
            }

            .pnl-rate {
                font-size: 12px;
                margin-top: 4px;
            }

            .pnl-content {
                padding: 0;
                margin-top: 15px;
            }

            .pnl-sector {
                margin-bottom: 12px;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                overflow: hidden;
            }

            .pnl-sector-header {
                padding: 12px 15px;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                background: rgba(255, 255, 255, 0.03);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .pnl-sector-name {
                font-size: 15px;
                flex: 1;
                color: #e8eaf0;
            }

            .pnl-sector-stats {
                gap: 15px;
            }

            .pnl-sector-total {
                font-size: 18px;
                font-weight: 800;
                color: #ffffff;
            }

            .pnl-sector-asset {
                font-size: 15px;
                color: #b8bcc8;
            }

            .pnl-sector-rate {
                font-size: 12px;
            }

            /* ÊâãÊú∫Á´ØÔºöÈöêËóèË°®Ê†ºÔºåÊòæÁ§∫Âç°Áâá */
            .pnl-table {
                display: none;
            }

            .pnl-mobile-list {
                display: block;
            }

            /* Ë°®Ê†º‰ºòÂåñ */
            .pnl-table {
                font-size: 12px;
            }

            .pnl-table th,
            .pnl-table td {
                padding: 10px 8px;
            }

            .fund-code {
                font-size: 12px;
            }

            .fund-name {
                font-size: 13px;
                font-weight: 600;
            }

            .nav-value,
            .growth-rate,
            .share-amount,
            .daily-profit {
                font-size: 13px;
            }

            /* ÊùøÂùóÂç°Áâá */
            .sector-card {
                margin-bottom: 15px;
            }

            .card-header {
                padding: 10px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                width: 100%;
            }

            .sector-name-input {
                font-size: 16px;
                width: 100%;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .table-wrap {
                padding: 10px 15px 15px 15px;
                overflow-x: auto;
            }

            .fund-table {
                min-width: 600px;
            }

            .fund-table th,
            .fund-table td {
                padding: 10px 5px;
                font-size: 12px;
            }

            .tb-input {
                padding: 6px 8px;
                font-size: 12px;
            }

            .result-pill {
                padding: 6px 10px;
                font-size: 14px;
                min-width: 70px;
            }

            /* Â∫ïÈÉ®Á≠ñÁï•Âç°Áâá */
            .strategy-footer {
                margin-top: 20px;
                margin-bottom: 20px;
                gap: 15px;
            }

            .info-card {
                padding: 20px;
            }

            .info-title {
                font-size: 16px;
                margin-bottom: 15px;
            }

            .strategy-list li,
            .rules-list li {
                font-size: 13px;
                margin-bottom: 12px;
            }

            /* Áî®Êà∑IDÁÆ°ÁêÜÂºπÁ™ó */
            .modal-overlay {
                background: rgba(0, 0, 0, 0.85);
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
                background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            }

            .modal-title {
                font-size: 18px;
                color: #e8eaf0;
            }

            .modal-section {
                padding: 15px;
                margin-bottom: 20px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .modal-label {
                color: rgba(255, 255, 255, 0.7);
            }

            .modal-value {
                font-size: 12px;
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: #64b5f6;
            }

            .copy-btn {
                width: 100%;
                background: rgba(100, 181, 246, 0.2);
                border: 1px solid rgba(100, 181, 246, 0.4);
                color: #64b5f6;
            }

            .modal-input {
                font-size: 14px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: #ffffff;
            }
            
            .modal-input::placeholder {
                color: rgba(255, 255, 255, 0.4);
            }
            
            .modal-hint {
                color: rgba(255, 255, 255, 0.5);
            }

            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .modal-btn {
                width: 100%;
                padding: 12px;
            }
            
            .modal-btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
            }
            
            .modal-btn-secondary {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #e8eaf0;
            }
            
            .modal-btn-danger {
                background: linear-gradient(135deg, #ff5757 0%, #ff4d4f 100%);
                border: none;
            }

            /* ÈöêËóè‰∏çÂøÖË¶ÅÁöÑÂÖÉÁ¥† - ÊâãÊú∫Á´ØÂè™ÊòæÁ§∫Êï∞ÊçÆÊü•Áúã */
            .dashboard-config,
            .analysis-dashboard,
            .compound-dashboard,
            .sector-card,
            .btn-add-sector,
            .strategy-footer,
            #overBudgetWarning,
            #rebalancePanel,
            #compoundPanel,
            #estimatePanel {
                display: none !important;
            }

            /* Áî®Êà∑IDÊòæÁ§∫ */
            #userIdDisplay {
                font-size: 10px;
                word-break: break-all;
            }

            #currentUserId {
                display: block;
                margin-top: 5px;
            }
        }

        /* Â∞èÂ±èÊâãÊú∫‰ºòÂåñ (< 480px) */
        @media (max-width: 480px) {
            body {
                background: #0a0e1a;
            }
            
            .dashboard-config {
                padding: 10px;
            }

            .summary-val {
                font-size: 20px;
            }

            .btn-dash {
                font-size: 10px;
                padding: 6px 8px;
            }

            .index-refresh-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .index-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .index-item {
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
            }

            .index-name {
                font-size: 11px;
            }

            .index-value {
                font-size: 18px;
            }

            .index-change {
                font-size: 12px;
            }

            .pnl-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .pnl-summary-item {
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
            }

            .pnl-label {
                font-size: 10px;
            }

            .pnl-value,
            .pnl-count,
            .pnl-count-total {
                font-size: 20px;
            }

            .pnl-value-large {
                font-size: 18px;
            }

            .pnl-rate {
                font-size: 11px;
            }

            .pnl-sector-name {
                font-size: 14px;
            }

            .pnl-sector-total {
                font-size: 18px;
            }

            .pnl-table {
                font-size: 10px;
            }

            .fund-table {
                min-width: 500px;
            }
        }

    </style>
</head>
<body>

<div class="container">

    <!-- ÊåáÊï∞Èù¢Êùø -->
    <div class="index-dashboard">
        <div class="index-title">
            <span>üìä ÂÖ®ÁêÉÂ∏ÇÂú∫ÊåáÊï∞</span>
            <button class="index-refresh-btn" onclick="showUserIdManager()" title="ÁÆ°ÁêÜÁî®Êà∑ID">üîë Áî®Êà∑ID</button>
            <button class="index-refresh-btn" onclick="location.reload()">üîÑ Âà∑Êñ∞</button>
        </div>
        <div class="index-grid">
            <div class="index-item" id="index-ndx">
                <div class="index-name">Á∫≥ÊñØËææÂÖã100</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-spx">
                <div class="index-name">Ê†áÊôÆ500</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-csi300">
                <div class="index-name">Ê≤™Ê∑±300</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-redlow">
                <div class="index-name">‰∏≠ËØÅÁ∫¢Âà©‰ΩéÊ≥¢</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-gold">
                <div class="index-name">ÈªÑÈáë</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
        </div>
    </div>

    <div class="daily-pnl-dashboard" id="dailyPnlPanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">üí∞ ÊåÅ‰ªìÁúãÊùø</div>
            </div>
            <div class="pnl-summary">
                <div class="pnl-summary-item">
                    <span class="pnl-label">ÊåÅ‰ªìÂ∏ÇÂÄº</span>
                    <span class="pnl-value-large" id="totalAssetInPnl">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">Á¥ØËÆ°Êî∂Áõä</span>
                    <span class="pnl-value-large" id="totalProfitInPnl">0</span>
                    <span class="pnl-rate" id="totalProfitRateInPnl">0%</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">‰ªäÊó•Êî∂Áõä</span>
                    <span class="pnl-value" id="totalDailyPnl">0</span>
                    <span class="pnl-rate" id="dailyProfitRate">0%</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">ÊåÅ‰ªìÂü∫ÈáëÊï∞</span>
                    <span class="pnl-count-total" id="totalFundCount">0</span>
                    <span class="pnl-rate" id="profitLossRatio">0/0</span>
                </div>
            </div>
            <div class="pnl-loading" id="pnlLoading">
                <div class="loading-spinner"></div>
                <div>Ê≠£Âú®Ëé∑Âèñ‰ªäÊó•ÂáÄÂÄºÊï∞ÊçÆ...</div>
            </div>
        </div>
        <div class="pnl-content" id="pnlContent"></div>
    </div>

    <div class="dashboard-config">
        <div style="flex: 1;">
            <div class="config-group">
                <div class="config-item">
                    <label>üéØ ËÆ°ÂàíÊÄªÊäïÂÖ• (ÂÖÉ)</label>
                    <input type="number" id="totalGoal" class="dash-input" value="700000" onchange="calcAll()">
                </div>
                <div class="config-item">
                    <label>üìÖ ËÆ°ÂàíÂÆöÊäïÂë®Êúü (Êúà)</label>
                    <input type="number" id="months" class="dash-input" value="24" onchange="calcAll()">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-dash" id="btnToggleRb" onclick="toggleRebalance()">üìä ÊòæÁ§∫ÂÜçÂπ≥Ë°°</button>
                <button class="btn-dash" id="btnToggleCp" onclick="toggleCompound()">üßÆ Â§çÂà©Êé®Êºî</button>
                <button class="btn-dash" id="btnToggleEst" onclick="toggleEstimate()">üìà ÂÆûÊó∂È¢Ñ‰º∞</button>
                <button class="btn-dash" onclick="syncAllFundNav()">üîÑ ÂêåÊ≠•ÂÆûÊó∂ÂáÄÂÄº</button>
                <button class="btn-dash" onclick="saveToCloud()" title="ÊâãÂä®‰øùÂ≠òÂà∞‰∫ëÁ´Ø">‚òÅÔ∏è ‰øùÂ≠òÂà∞‰∫ëÁ´Ø</button>
                <button class="btn-dash" onclick="loadFromCloudManual()" title="‰ªé‰∫ëÁ´ØÈáçÊñ∞Âä†ËΩΩ">üì• ‰ªé‰∫ëÁ´ØÂä†ËΩΩ</button>
                <button class="btn-dash" onclick="exportData()">‚¨áÔ∏è Â§á‰ªΩÈÖçÁΩÆ</button>
                <button class="btn-dash" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è ÊÅ¢Â§çÈÖçÁΩÆ</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <div id="syncStatus" style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.8);"></div>
            <div id="userIdDisplay" style="margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.6);">
                Áî®Êà∑ID: <span id="currentUserId" style="font-family: monospace;">--</span>
            </div>
        </div>

        <div class="summary-group">
            <div class="summary-item">
                <div class="summary-label">Â∑≤ÊåÅ‰ªìÂ∏ÇÂÄº</div>
                <div class="summary-val">¬•<span id="currTotalAsset">0</span></div>
                <div class="summary-sub" id="totalProfitDisplay">--</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Ââ©‰ΩôÈúÄÊäïÂÖ•</div>
                <div class="summary-val">¬•<span id="remainToInvest">0</span></div>
                <div class="summary-sub">ÂÆöÊäïÁõÆÊ†áÁº∫Âè£</div>
            </div>
        </div>
    </div>

    <div id="overBudgetWarning" class="warning-box">
        ‚ö†Ô∏è Ë≠¶ÂëäÔºöÂΩìÂâçÊåÅ‰ªìÂ∑≤Ë∂ÖËøáÊÄªÊäïÂÖ•ÁõÆÊ†áÔºåËØ∑Â¢ûÂä†ÊÄªÊäïÂÖ•È¢ÑÁÆó„ÄÇ
    </div>

    <div class="analysis-dashboard" id="rebalancePanel">
        <div class="chart-card">
            <div class="chart-container-inner">
                <canvas id="assetChart"></canvas>
            </div>
            <div style="position:absolute; pointer-events:none; text-align:center;">
                <div style="font-size:12px; color:#999;">ÊåÅ‰ªìÂàÜÂ∏É</div>
                <div style="font-weight:bold; font-size:18px;">ÂÆûÊó∂</div>
            </div>
        </div>

        <div class="rebalance-card">
            <div class="rb-title">‚öñÔ∏è Êô∫ËÉΩÂÜçÂπ≥Ë°°Âª∫ËÆÆ (Smart Rebalance)</div>
            <table class="rb-table">
                <thead>
                    <tr>
                        <th>ÊùøÂùó</th>
                        <th style="text-align:center">ÂÆûÈôÖ%</th>
                        <th style="text-align:center">ÁõÆÊ†á%</th>
                        <th style="text-align:center">Áä∂ÊÄÅ</th>
                        <th style="text-align:right">Âª∫ËÆÆÊìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody id="rebalanceBody"></tbody>
            </table>
            <div class="rb-tip">
                üí° <strong>ËØ¥ÊòéÔºö</strong><br>
                ‚Ä¢ ÂÅèÂ∑ÆË∂ÖËøá 2% Ëß¶ÂèëÈ¢úËâ≤ÊèêÁ§∫„ÄÇ<br>
                ‚Ä¢ <strong>Êìç‰ΩúÂª∫ËÆÆ</strong>ÔºöÊ≠£Êï∞‰∏∫‚ÄúÈúÄ‰π∞ÂÖ•ÈáëÈ¢ù‚Äù(Á∫¢Ëâ≤)ÔºåË¥üÊï∞‰∏∫‚ÄúÈúÄÂçñÂá∫ÈáëÈ¢ù‚Äù(ÁªøËâ≤)„ÄÇ<br>
                ‚Ä¢ Âª∫ËÆÆ‰ºòÂÖàÈÄöËøá‰∏ãÊñπ‚ÄúÂÆöÊäï‚ÄùÊù•Âä®ÊÄÅÂπ≥Ë°°Ôºà‰π∞ÂÖ•‰ΩéÈÖçÔºâÔºåËÄå‰∏çÊòØÈ¢ëÁπÅÂçñÂá∫„ÄÇ
            </div>
        </div>
    </div>

    <div class="compound-dashboard" id="compoundPanel">
        <div class="compound-inputs">
            <div class="cp-title">üîÆ Â§çÂà©ËÆ°ÁÆóÂô® (Compound Interest)</div>
            <div class="input-row">
                <label>ÊäïÂÖ•ÊÄªÈ¢ù (ÂÖÉ)</label>
                <input type="number" id="cpPrincipal" value="1000000" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>È¢Ñ‰º∞Âπ¥ÂåñÊî∂ÁõäÁéá (%)</label>
                <input type="number" id="cpRate" value="10" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>ÊåÅÊúâÂπ¥Êï∞</label>
                <input type="number" id="cpYears" value="10" onchange="calcCompound()">
            </div>
            <div class="result-box">
                <div class="res-label">A. ‰∏ÄÊ¨°ÊÄßÊäïÂÖ• NÂπ¥ÂêéÊÄªÈ¢ù</div>
                <div class="res-val type-a" id="resLumpSum">¬•0</div>
            </div>
            <div class="result-box">
                <div class="res-label">B. ÂÆöÊäï NÂπ¥ÂêéÊÄªÈ¢ù (Âà∞ËææÊÄªÈ¢ù)</div>
                <div class="res-val type-b" id="resDCA">¬•0</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">(ÊúàÂÆöÊäï: <span id="cpMonthlyInput">¬•0</span>)</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container-inner" style="max-height: 400px;">
                <canvas id="compoundChart"></canvas>
            </div>
        </div>
    </div>

    <div class="daily-pnl-dashboard" id="estimatePanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">üìà ÂÆûÊó∂È¢Ñ‰º∞ (Real-time Estimate)</div>
            </div>
            <div class="pnl-summary">
                <div class="pnl-summary-item">
                    <span class="pnl-label">È¢Ñ‰º∞ÊÄªÊî∂Áõä</span>
                    <span class="pnl-value" id="totalEstimatePnl">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">ÁõàÂà©Âü∫Èáë</span>
                    <span class="pnl-count" id="estimateProfitCount">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">‰∫èÊçüÂü∫Èáë</span>
                    <span class="pnl-count loss" id="estimateLossCount">0</span>
                </div>
            </div>
            <div class="pnl-loading" id="estimateLoading">
                <div class="loading-spinner"></div>
                <div>Ê≠£Âú®Ëé∑ÂèñÂÆûÊó∂‰º∞ÁÆóÊï∞ÊçÆ...</div>
            </div>
        </div>
        <div class="pnl-content" id="estimateContent"></div>
    </div>

    <div id="sectors-container"></div>

    <button class="btn-add-sector" onclick="createNewSector()">+ Ê∑ªÂä†Êñ∞ÊùøÂùó (Add Sector)</button>

    <div class="strategy-footer">
        <div class="info-card">
            <div class="info-title">üöÄ Êô∫ËÉΩÂä†‰ªìÁ≠ñÁï•</div>
            <ul class="strategy-list">
                <li><span class="dot green"></span> <strong>Â∏∏ËßÑÂõûË∞É (-10% ~ -15%)</strong><br>Áª¥ÊåÅÂéüËÆ°ÂàíÔºå‰∏çÂä®Â¶ÇÂ±±„ÄÇ</li>
                <li><span class="dot yellow"></span> <strong>ÊäÄÊúØÁÜäÂ∏Ç (-20% ~ -25%)</strong><br>ÂêØÂä® <span class="highlight-text">1.5ÂÄç - 2ÂÄç</span> ÂÆöÊäï„ÄÇ</li>
                <li><span class="dot red"></span> <strong>Âè≤ËØóÂ¥©Áõò (> -30%)</strong><br>Âä®Áî®Â§áÁî®ÈáëÔºåÊØèË∑å5% <span class="highlight-text">ÊâãÂä®‰π∞ÂÖ•Â§ßÈ¢ù</span>„ÄÇ</li>
            </ul>
        </div>
        <div class="info-card">
            <div class="info-title">üìú ÂÆöÊäïÂÜõËßÑ</div>
            <ul class="rules-list">
                <li>1. Âè™Ë¶Å‰∏çÂ§±‰∏öÔºåÁªù‰∏çÂÅúÊ≠¢Êâ£Ê¨æÔºàÂ∫ïÁ∫øÔºâ„ÄÇ</li>
                <li>2. Âª∫‰ªìÊúü‰∏ãË∑åÊòØÂ•Ω‰∫ãÔºåË¶Å‚ÄúÁ¨ëÁùÄÂä†‰ªì‚Äù„ÄÇ</li>
                <li>3. ÊØèÂπ¥ÁîüÊó•Ê£ÄÊü•‰∏ÄÊ¨°Âä®ÊÄÅÂπ≥Ë°°ÔºåËã•ËÇ°Á•®Âç†ÊØî>75%ÂàôÊ≠¢ÁõàËΩ¨ÂÄ∫„ÄÇ</li>
                <li>4. <strong>ÁæéËÇ°ÈôêË¥≠</strong>: ÂêØÁî®Â§öAPPÔºàÂçóÊñπ/ÂçöÊó∂/ÊãõË°åÔºâÂàÜÊµÅ„ÄÇ</li>
            </ul>
        </div>
    </div>

</div>

<!-- Áî®Êà∑IDÁÆ°ÁêÜÂºπÁ™ó -->
<div id="userIdModal" class="modal-overlay" onclick="if(event.target === this) closeUserIdManager()">
    <div class="modal-content">
        <div class="modal-title">üîë Áî®Êà∑IDÁÆ°ÁêÜ</div>
        
        <div class="modal-section">
            <div class="modal-label">ÂΩìÂâçÁî®Êà∑ID</div>
            <div class="modal-value">
                <span id="modalUserId">--</span>
                <button class="copy-btn" onclick="copyUserId()">Â§çÂà∂</button>
            </div>
            <div class="modal-hint">
                üí° Âú®ÂÖ∂‰ªñËÆæÂ§á‰∏ä‰ΩøÁî®Áõ∏ÂêåÁöÑÁî®Êà∑IDÔºåÂç≥ÂèØÂêåÊ≠•Êï∞ÊçÆ
            </div>
        </div>

        <div class="modal-section">
            <div class="modal-label">ËÆæÁΩÆÊñ∞ÁöÑÁî®Êà∑ID</div>
            <input type="text" id="newUserIdInput" class="modal-input" placeholder="Á≤òË¥¥Áî®Êà∑ID...">
            <div class="modal-hint">
                ‚ö†Ô∏è ËÆæÁΩÆÊñ∞IDÂêéÔºåÂ∞ÜÂä†ËΩΩËØ•IDÂØπÂ∫îÁöÑÊï∞ÊçÆ
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-danger" onclick="resetUserId()">üîÑ ÈáçÁΩÆID</button>
            <button class="modal-btn modal-btn-primary" onclick="setNewUserId()">‚úÖ ËÆæÁΩÆID</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeUserIdManager()">ÂèñÊ∂à</button>
        </div>
    </div>
</div>

<script>
    // ===== ÁâàÊú¨ÊéßÂà∂ =====
    const APP_VERSION = 'v6.5.1'; // ÁâàÊú¨Âè∑
    console.log('üì¶ Â∫îÁî®ÁâàÊú¨:', APP_VERSION);
    
    // ===== Supabase ‰∫ëÁ´ØÂ≠òÂÇ®ÈÖçÁΩÆ =====
    const SUPABASE_URL = 'https://tweusnlqlgiiuchlfbdr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3ZXVzbmxxbGdpaXVjaGxmYmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjkxMjksImV4cCI6MjA4NTk0NTEyOX0.3-JvqUMlHigtjwcGHZDdaOhvwq1dDLeoqn2A0gxXNPg';
    
    // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´ØÔºà‰ΩøÁî® var ÈÅøÂÖçÈáçÂ§çÂ£∞ÊòéÈîôËØØÔºâ
    var supabase;
    if (typeof window.supabaseClient === 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        window.supabaseClient = supabase;
        console.log('‚úÖ Supabase ÂÆ¢Êà∑Á´ØÂàùÂßãÂåñÊàêÂäü');
    } else {
        supabase = window.supabaseClient;
        console.log('‚ôªÔ∏è ‰ΩøÁî®Â∑≤Â≠òÂú®ÁöÑ Supabase ÂÆ¢Êà∑Á´Ø');
    }
    
    // ÁîüÊàêÊàñËé∑ÂèñÁî®Êà∑ID
    var userId = localStorage.getItem('userId');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        console.log('üÜî ÁîüÊàêÊñ∞Áî®Êà∑ID:', userId);
    } else {
        console.log('üÜî ‰ΩøÁî®Áé∞ÊúâÁî®Êà∑ID:', userId);
    }
    
    // ===== ‰∫ëÁ´ØÂ≠òÂÇ®ÂáΩÊï∞ =====
    
    /**
     * ‰øùÂ≠òÊï∞ÊçÆÂà∞‰∫ëÁ´Ø
     */
    async function saveToCloud() {
        try {
            showNotification('Ê≠£Âú®‰øùÂ≠òÂà∞‰∫ëÁ´Ø...', 'info');
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËØ•Áî®Êà∑ÁöÑÊï∞ÊçÆ
            const { data: existingData, error: queryError } = await supabase
                .from('fund_data')
                .select('id')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (existingData) {
                // Êõ¥Êñ∞Áé∞ÊúâÊï∞ÊçÆ
                const { error } = await supabase
                    .from('fund_data')
                    .update({
                        data: appData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userId);
                
                if (error) throw error;
                console.log('‚úÖ Êõ¥Êñ∞‰∫ëÁ´ØÊï∞ÊçÆÊàêÂäü');
            } else {
                // ÊèíÂÖ•Êñ∞Êï∞ÊçÆ
                const { error } = await supabase
                    .from('fund_data')
                    .insert({
                        user_id: userId,
                        data: appData,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                console.log('‚úÖ ÂàõÂª∫‰∫ëÁ´ØÊï∞ÊçÆÊàêÂäü');
            }
            
            showNotification('Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞‰∫ëÁ´Ø', 'success');
            return true;
        } catch (error) {
            console.error('‚ùå ‰øùÂ≠òÂà∞‰∫ëÁ´ØÂ§±Ë¥•:', error);
            showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            return false;
        }
    }
    
    /**
     * ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆ
     */
    async function loadFromCloud() {
        try {
            const { data, error } = await supabase
                .from('fund_data')
                .select('data, updated_at')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (error) throw error;
            
            if (data) {
                console.log('‚úÖ ‰ªé‰∫ëÁ´ØÂä†ËΩΩÊï∞ÊçÆÊàêÂäü');
                console.log('üìÖ ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥:', new Date(data.updated_at).toLocaleString('zh-CN'));
                return data.data;
            }
            
            console.log('‚ö†Ô∏è ‰∫ëÁ´ØÊ≤°ÊúâÊï∞ÊçÆ');
            return null;
        } catch (error) {
            console.error('‚ùå ‰ªé‰∫ëÁ´ØÂä†ËΩΩÂ§±Ë¥•:', error);
            showNotification('Âä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
            return null;
        }
    }
    
    /**
     * ÊâãÂä®‰ªé‰∫ëÁ´ØÂä†ËΩΩ
     */
    async function loadFromCloudManual() {
        showNotification('Ê≠£Âú®‰ªé‰∫ëÁ´ØÂä†ËΩΩ...', 'info');
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            appData = cloudData;
            renderApp();
            calcAll();
            showNotification('Êï∞ÊçÆÂ∑≤‰ªé‰∫ëÁ´ØÂä†ËΩΩ', 'success');
        } else {
            showNotification('‰∫ëÁ´ØÊ≤°ÊúâÊï∞ÊçÆ', 'warning');
        }
    }
    
    /**
     * ÊòæÁ§∫ÈÄöÁü•
     */
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: '#52c41a',
            error: '#ff4d4f',
            info: '#1890ff',
            warning: '#faad14'
        };
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${colors[type]};
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // Ê∑ªÂä†CSSÂä®Áîª
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    // --- ÈªòËÆ§Êï∞ÊçÆÊ®°Áâà ---
    const DEFAULT_DATA = {
        totalGoal: 1000000,
        months: 24,
        sectors: [
            {
                id: 'sec_1', name: 'US ÁæéËÇ° (ËøõÊîª‰∏ªÂäõ)', color: '#dc2626', weight: 35, strategy: 'sip',
                funds: [{ name: 'Êë©Ê†πÊ†áÊôÆ500(A)', code: '019303', share: 0, cost: 0, nav: 1.0, percent: 60 }]
            },
            {
                id: 'sec_2', name: 'CN AËÇ° (ÊàêÈïøÂ§çËãè)', color: '#db2777', weight: 20, strategy: 'sip',
                funds: [{ name: 'ÂÖ¥ÂÖ®ÂêàÊ∂¶', code: '163406', share: 0, cost: 0, nav: 1.0, percent: 70 }]
            },
            {
                id: 'sec_3', name: 'Á∫¢Âà©‰ΩéÊ≥¢', color: '#059669', weight: 15, strategy: 'sip',
                funds: [{ name: 'ÂçóÊñπÁ∫¢Âà©‰ΩéÊ≥¢', code: '008163', share: 0, cost: 0, nav: 1.0, percent: 65 }]
            },
            {
                id: 'sec_4', name: 'ÈªÑÈáëÈÅøÈô©', color: '#d97706', weight: 15, strategy: 'sip',
                funds: [{ name: 'Â∑•Èì∂ÈªÑÈáëETF', code: '008142', share: 0, cost: 0, nav: 1.0, percent: 100 }]
            },
            {
                id: 'sec_5', name: 'ÂÄ∫Âü∫Â∫ï‰ªì', color: '#1890ff', weight: 15, strategy: 'fill',
                funds: [{ name: 'ÊãõÂïÜ‰∫ß‰∏öÂÄ∫A', code: '217022', share: 0, cost: 0, nav: 1.0, percent: 100 }]
            }
        ]
    };

    let appData = null;
    let myChart = null; // ÂÜçÂπ≥Ë°°ÂõæË°®
    let compoundChart = null; // Â§çÂà©ÂõæË°®

    // --- ÂàùÂßãÂåñ ---
    window.onload = async function() {
        // ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
        showNotification('Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...', 'info');
        
        // ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑ID
        updateUserIdDisplay();
        
        // ‰ºòÂÖà‰ªé‰∫ëÁ´ØÂä†ËΩΩ
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            // ‰ΩøÁî®‰∫ëÁ´ØÊï∞ÊçÆ
            appData = cloudData;
            console.log('üì• ‰ΩøÁî®‰∫ëÁ´ØÊï∞ÊçÆ');
        } else {
            // Â∞ùËØï‰ªéÊú¨Âú∞Âä†ËΩΩ
            const saved = localStorage.getItem('smartSIP_data_v7');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    if (!appData.sectors) throw new Error("Format error");
                    console.log('üì• ‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ');
                    // Â∞ÜÊú¨Âú∞Êï∞ÊçÆÂêåÊ≠•Âà∞‰∫ëÁ´Ø
                    saveToCloud().catch(err => console.error('ÂêåÊ≠•Â§±Ë¥•:', err));
                } catch (e) {
                    console.error(e);
                    appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    console.log('üì• ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ');
                }
            } else {
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                console.log('üì• ‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ');
            }
        }
        
        initChart(); 
        renderApp();
        loadIndexData(); // Âä†ËΩΩÊåáÊï∞Êï∞ÊçÆ
        loadDailyPnL(); // Ëá™Âä®Âä†ËΩΩ‰ªäÊó•Áõà‰∫è
    };

    // --- Áî®Êà∑IDÁÆ°ÁêÜÂäüËÉΩ ---
    
    /**
     * Êõ¥Êñ∞È°µÈù¢‰∏äÊòæÁ§∫ÁöÑÁî®Êà∑ID
     */
    function updateUserIdDisplay() {
        const displayEl = document.getElementById('currentUserId');
        if (displayEl) {
            displayEl.textContent = userId;
        }
    }
    
    /**
     * ÊòæÁ§∫Áî®Êà∑IDÁÆ°ÁêÜÂºπÁ™ó
     */
    function showUserIdManager() {
        const modal = document.getElementById('userIdModal');
        const modalUserId = document.getElementById('modalUserId');
        const newUserIdInput = document.getElementById('newUserIdInput');
        
        modalUserId.textContent = userId;
        newUserIdInput.value = '';
        modal.style.display = 'flex';
    }
    
    /**
     * ÂÖ≥Èó≠Áî®Êà∑IDÁÆ°ÁêÜÂºπÁ™ó
     */
    function closeUserIdManager() {
        const modal = document.getElementById('userIdModal');
        modal.style.display = 'none';
    }
    
    /**
     * Â§çÂà∂Áî®Êà∑IDÂà∞Ââ™Ë¥¥Êùø
     */
    function copyUserId() {
        const textToCopy = userId;
        
        // Â∞ùËØï‰ΩøÁî®Áé∞‰ª£API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('Áî®Êà∑IDÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
            }).catch(err => {
                // ÈôçÁ∫ßÊñπÊ°à
                fallbackCopy(textToCopy);
            });
        } else {
            // ÈôçÁ∫ßÊñπÊ°à
            fallbackCopy(textToCopy);
        }
    }
    
    /**
     * ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°àÔºàÂÖºÂÆπÊóßÊµèËßàÂô®Ôºâ
     */
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            showNotification('Áî®Êà∑IDÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
        } catch (err) {
            showNotification('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
        }
        
        document.body.removeChild(textArea);
    }
    
    /**
     * ËÆæÁΩÆÊñ∞ÁöÑÁî®Êà∑ID
     */
    async function setNewUserId() {
        const newUserIdInput = document.getElementById('newUserIdInput');
        const newUserId = newUserIdInput.value.trim();
        
        if (!newUserId) {
            showNotification('ËØ∑ËæìÂÖ•Áî®Êà∑ID', 'warning');
            return;
        }
        
        if (newUserId === userId) {
            showNotification('Êñ∞ID‰∏éÂΩìÂâçIDÁõ∏Âêå', 'warning');
            return;
        }
        
        if (!confirm(`Á°ÆÂÆöË¶ÅÂàáÊç¢Âà∞Êñ∞ÁöÑÁî®Êà∑IDÂêóÔºü\n\nÊñ∞ID: ${newUserId}\n\nÂàáÊç¢ÂêéÂ∞ÜÂä†ËΩΩËØ•IDÂØπÂ∫îÁöÑÊï∞ÊçÆ„ÄÇ`)) {
            return;
        }
        
        // ‰øùÂ≠òÊñ∞ÁöÑÁî®Êà∑ID
        userId = newUserId;
        localStorage.setItem('userId', userId);
        
        // Êõ¥Êñ∞ÊòæÁ§∫
        updateUserIdDisplay();
        
        // ÂÖ≥Èó≠ÂºπÁ™ó
        closeUserIdManager();
        
        // ÊòæÁ§∫ÊèêÁ§∫
        showNotification('Áî®Êà∑IDÂ∑≤Êõ¥Êñ∞ÔºåÊ≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...', 'info');
        
        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            appData = cloudData;
            renderApp();
            calcAll();
            showNotification('Êï∞ÊçÆÂ∑≤‰ªé‰∫ëÁ´ØÂä†ËΩΩ', 'success');
        } else {
            showNotification('‰∫ëÁ´ØÊ≤°ÊúâËØ•IDÁöÑÊï∞ÊçÆÔºåÂ∞Ü‰ΩøÁî®ÈªòËÆ§Êï∞ÊçÆ', 'warning');
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            renderApp();
            calcAll();
        }
    }
    
    /**
     * ÈáçÁΩÆÁî®Êà∑IDÔºàÁîüÊàêÊñ∞IDÔºâ
     */
    function resetUserId() {
        if (!confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÁî®Êà∑IDÂêóÔºü\n\nÈáçÁΩÆÂêéÂ∞ÜÁîüÊàêÊñ∞ÁöÑIDÔºåÂΩìÂâçÊï∞ÊçÆÂ∞Ü‰øùÁïôÂú®‰∫ëÁ´ØÔºå‰ΩÜÈúÄË¶Å‰ΩøÁî®ÊóßIDÊâçËÉΩËÆøÈóÆ„ÄÇ\n\nÂª∫ËÆÆÂÖàÂ§á‰ªΩÈÖçÁΩÆÔºÅ')) {
            return;
        }
        
        // ÁîüÊàêÊñ∞ID
        const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        userId = newUserId;
        localStorage.setItem('userId', userId);
        
        // Êõ¥Êñ∞ÊòæÁ§∫
        updateUserIdDisplay();
        document.getElementById('modalUserId').textContent = userId;
        
        // ÊòæÁ§∫ÊèêÁ§∫
        showNotification('Áî®Êà∑IDÂ∑≤ÈáçÁΩÆ: ' + userId, 'success');
        
        console.log('üÜî Êñ∞Áî®Êà∑ID:', userId);
    }

    // --- Âä†ËΩΩÊåáÊï∞Êï∞ÊçÆ ---
    function loadIndexData() {
        const indices = [
            { id: 'index-ndx', code: '100.NDX', name: 'Á∫≥ÊñØËææÂÖã100' },
            { id: 'index-spx', code: '100.SPX', name: 'Ê†áÊôÆ500' },
            { id: 'index-csi300', code: '1.000300', name: 'Ê≤™Ê∑±300' },
            { id: 'index-redlow', code: '1.515100', name: '‰∏≠ËØÅÁ∫¢Âà©‰ΩéÊ≥¢' },
            { id: 'index-gold', code: '1.518660', name: 'ÈªÑÈáë' }
        ];

        indices.forEach((index, i) => {
            setTimeout(() => {
                fetchIndexData(index.id, index.code, index.name);
            }, i * 300); // ‰∏≤Ë°åËØ∑Ê±ÇÔºåÈó¥Èöî300ms
        });
    }

    // Ëé∑ÂèñÂçï‰∏™ÊåáÊï∞Êï∞ÊçÆ
    function fetchIndexData(elementId, code, name) {
        // ‰ΩøÁî®KÁ∫øÊé•Âè£Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
        const script = document.createElement('script');
        const callbackName = 'indexCallback_' + elementId.replace(/-/g, '_') + '_' + Date.now();
        
        const timeout = setTimeout(() => {
            cleanup();
            console.error(`Ëé∑Âèñ${name}Êï∞ÊçÆË∂ÖÊó∂`);
            updateIndexDisplay(elementId, '--', 0, true);
        }, 10000);

        function cleanup() {
            delete window[callbackName];
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
        }

        window[callbackName] = function(result) {
            clearTimeout(timeout);
            cleanup();
            
            try {
                if (result.rc === 0 && result.data && result.data.klines && result.data.klines.length > 0) {
                    const klines = result.data.klines;
                    
                    // Ëé∑ÂèñÊúÄÊñ∞‰∏ÄÂ§©ÁöÑÊï∞ÊçÆ
                    const latestKline = klines[klines.length - 1];
                    const parts = latestKline.split(',');
                    
                    if (parts.length >= 3) {
                        const latest = parseFloat(parts[2]); // ÊúÄÊñ∞Êî∂Áõò‰ª∑
                        
                        // Ëé∑ÂèñÊò®Êó•Êî∂Áõò‰ª∑
                        let yesterday = parseFloat(parts[1]); // ‰ªäÊó•ÂºÄÁõò‰ª∑ÔºàÈÄöÂ∏∏Á≠â‰∫éÊò®Êó•Êî∂ÁõòÔºâ
                        
                        // Â¶ÇÊûúÊúâÂâç‰∏ÄÂ§©ÁöÑÊï∞ÊçÆÔºå‰ΩøÁî®Ââç‰∏ÄÂ§©ÁöÑÊî∂Áõò‰ª∑Êõ¥ÂáÜÁ°Æ
                        if (klines.length >= 2) {
                            const prevKline = klines[klines.length - 2];
                            const prevParts = prevKline.split(',');
                            if (prevParts.length >= 3) {
                                yesterday = parseFloat(prevParts[2]);
                            }
                        }
                        
                        const change = latest - yesterday;
                        const changePercent = yesterday > 0 ? (change / yesterday * 100) : 0;

                        updateIndexDisplay(elementId, latest, changePercent);
                    } else {
                        updateIndexDisplay(elementId, '--', 0, true);
                    }
                } else {
                    updateIndexDisplay(elementId, '--', 0, true);
                }
            } catch (e) {
                console.error(`Ëß£Êûê${name}Êï∞ÊçÆÂ§±Ë¥•:`, e);
                updateIndexDisplay(elementId, '--', 0, true);
            }
        };

        script.onerror = () => {
            clearTimeout(timeout);
            cleanup();
            console.error(`Âä†ËΩΩ${name}Êï∞ÊçÆÂ§±Ë¥•`);
            updateIndexDisplay(elementId, '--', 0, true);
        };

        // ‰ΩøÁî®KÁ∫øÊé•Âè£ÔºåËé∑ÂèñÊúÄËøë2Â§©Êï∞ÊçÆ
        script.src = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${code}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=0&end=20500101&lmt=2&cb=${callbackName}`;
        document.head.appendChild(script);
    }

    // Êõ¥Êñ∞ÊåáÊï∞ÊòæÁ§∫
    function updateIndexDisplay(elementId, value, changePercent, isError = false) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const valueEl = element.querySelector('.index-value');
        const changeEl = element.querySelector('.index-change');

        if (isError) {
            valueEl.textContent = '--';
            changeEl.textContent = 'Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•';
            changeEl.className = 'index-change zero';
            return;
        }

        // Êõ¥Êñ∞Êï∞ÂÄº
        if (typeof value === 'number') {
            valueEl.textContent = value.toFixed(2);
        } else {
            valueEl.textContent = value;
        }

        // Êõ¥Êñ∞Ê∂®Ë∑åÂπÖ
        if (changePercent > 0) {
            changeEl.textContent = `+${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change positive';
        } else if (changePercent < 0) {
            changeEl.textContent = `${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change negative';
        } else {
            changeEl.textContent = '0.00%';
            changeEl.className = 'index-change zero';
        }
    }

    // --- ÂäüËÉΩÂºÄÂÖ≥ ---
    function toggleRebalance() {
        const panel = document.getElementById('rebalancePanel');
        const btn = document.getElementById('btnToggleRb');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? 'ü´£ ÈöêËóèÂÜçÂπ≥Ë°°' : 'üìä ÊòæÁ§∫ÂÜçÂπ≥Ë°°';
        btn.classList.toggle('btn-toggle-active');
        if(isHidden && myChart) myChart.resize(); 
    }

    function toggleCompound() {
        const panel = document.getElementById('compoundPanel');
        const btn = document.getElementById('btnToggleCp');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? 'ü´£ ÈöêËóèÊé®Êºî' : 'üßÆ Â§çÂà©Êé®Êºî';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // È¶ñÊ¨°Â±ïÂºÄÊó∂ÔºåËá™Âä®Â°´ÂÖ•ÂΩìÂâçÊÄªÊäïÂÖ•ÁõÆÊ†á‰Ωú‰∏∫Êú¨Èáë
            if(document.getElementById('cpPrincipal').value == "1000000") {
                document.getElementById('cpPrincipal').value = document.getElementById('totalGoal').value;
            }
            calcCompound(); // ËÆ°ÁÆóÂπ∂ÁªòÂõæ
        }
    }

    function toggleEstimate() {
        const panel = document.getElementById('estimatePanel');
        const btn = document.getElementById('btnToggleEst');
        const isHidden = panel.style.display !== 'block';
        
        panel.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? 'ü´£ ÈöêËóèÈ¢Ñ‰º∞' : 'üìà ÂÆûÊó∂È¢Ñ‰º∞';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // È¶ñÊ¨°Â±ïÂºÄÊó∂ÔºåËá™Âä®Ëé∑ÂèñÂÆûÊó∂È¢Ñ‰º∞
            loadEstimate();
        }
    }

    // Âä†ËΩΩ‰ªäÊó•Áõà‰∫èÊï∞ÊçÆ
    function loadDailyPnL() {
        const loadingEl = document.getElementById('pnlLoading');
        const contentEl = document.getElementById('pnlContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // Êî∂ÈõÜÊâÄÊúâÂü∫Èáë
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">ÊöÇÊó†ÊåÅ‰ªìÂü∫Èáë</div>';
            return;
        }
        
        // ‰∏≤Ë°åËé∑ÂèñÊØèÂè™Âü∫ÈáëÁöÑ‰ªäÊó•Êï∞ÊçÆ
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // ÂÖ®ÈÉ®ÂÆåÊàêÔºåÊ∏≤ÊüìÁªìÊûú
                loadingEl.style.display = 'none';
                renderDailyPnL(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchDailyNavData(fund.code)
                .then(data => {
                    if (data.success) {
                        // ËÆ°ÁÆó‰ªäÊó•Êî∂Áõä
                        const todayNav = data.nav;
                        const yesterdayNav = data.yesterdayNav || todayNav;
                        const growthRate = yesterdayNav > 0 ? ((todayNav - yesterdayNav) / yesterdayNav * 100) : 0;
                        const dailyProfit = fund.share * (todayNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: todayNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            navDate: data.date
                        });
                    }
                })
                .catch(err => {
                    console.error(`Ëé∑Âèñ ${fund.code} Â§±Ë¥•:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // Ëé∑ÂèñÂü∫Èáë‰ªäÊó•ÂíåÊò®Êó•ÂáÄÂÄº
    function fetchDailyNavData(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                setTimeout(() => {
                    try {
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length >= 1) {
                                // ‰ªäÊó•ÂáÄÂÄº
                                const todayCells = rows[0].querySelectorAll('td');
                                const todayNav = parseFloat(todayCells[1].textContent.trim()) || 0;
                                const todayDate = todayCells[0].textContent.trim();
                                
                                // Êò®Êó•ÂáÄÂÄº
                                let yesterdayNav = todayNav;
                                if (rows.length >= 2) {
                                    const yesterdayCells = rows[1].querySelectorAll('td');
                                    yesterdayNav = parseFloat(yesterdayCells[1].textContent.trim()) || todayNav;
                                }
                                
                                clearTimeout(timeout);
                                cleanup();
                                resolve({
                                    success: true,
                                    code: code,
                                    nav: todayNav,
                                    yesterdayNav: yesterdayNav,
                                    date: todayDate
                                });
                                return;
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=2&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // Ê∏≤Êüì‰ªäÊó•Áõà‰∫è
    function renderDailyPnL(results) {
        const contentEl = document.getElementById('pnlContent');
        
        // ÊåâÊùøÂùóÂàÜÁªÑ
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // ËÆ°ÁÆóÊÄªÊî∂Áõä„ÄÅÊåÅ‰ªìÂ∏ÇÂÄºÂíåÊµÆÁõà
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        let totalAsset = 0;
        let totalCost = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
            
            // ËÆ°ÁÆóÊåÅ‰ªìÂ∏ÇÂÄºÂíåÊàêÊú¨
            const marketValue = item.share * item.todayNav;
            const costValue = item.share * item.costNav;
            totalAsset += marketValue;
            totalCost += costValue;
        });
        
        const totalFloatProfit = totalAsset - totalCost;
        const totalFloatProfitRate = totalCost > 0 ? (totalFloatProfit / totalCost * 100) : 0;
        
        // Êõ¥Êñ∞È°∂ÈÉ®Ê±áÊÄª - ‰ªäÊó•Êî∂Áõä
        const totalPnlEl = document.getElementById('totalDailyPnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        
        // ËÆ°ÁÆó‰ªäÊó•Êî∂ÁõäÁéá
        const dailyProfitRate = totalAsset > 0 ? (totalProfit / totalAsset * 100) : 0;
        const dailyProfitRateEl = document.getElementById('dailyProfitRate');
        dailyProfitRateEl.textContent = (dailyProfitRate >= 0 ? '+' : '') + dailyProfitRate.toFixed(2) + '%';
        dailyProfitRateEl.style.color = dailyProfitRate >= 0 ? '#ff4d4f' : '#52c41a';
        
        // Êõ¥Êñ∞ÊåÅ‰ªìÂü∫ÈáëÊï∞ÂíåÁõà‰∫èÊØî‰æãÔºàÂ∏¶È¢úËâ≤Ôºâ
        document.getElementById('totalFundCount').textContent = results.length;
        const profitLossRatioEl = document.getElementById('profitLossRatio');
        profitLossRatioEl.innerHTML = `<span style="color: #ff4d4f">${profitCount}</span>/<span style="color: #52c41a">${lossCount}</span>`;
        
        // Êõ¥Êñ∞ÊåÅ‰ªìÂ∏ÇÂÄº
        const totalAssetEl = document.getElementById('totalAssetInPnl');
        totalAssetEl.textContent = Math.round(totalAsset).toLocaleString();
        
        // Êõ¥Êñ∞Á¥ØËÆ°ÊµÆÁõà
        const totalProfitEl = document.getElementById('totalProfitInPnl');
        totalProfitEl.textContent = (totalFloatProfit >= 0 ? '+' : '') + Math.round(totalFloatProfit).toLocaleString();
        totalProfitEl.style.color = totalFloatProfit >= 0 ? '#ff4d4f' : '#52c41a';
        
        const totalProfitRateEl = document.getElementById('totalProfitRateInPnl');
        totalProfitRateEl.textContent = (totalFloatProfitRate >= 0 ? '+' : '') + totalFloatProfitRate.toFixed(2) + '%';
        totalProfitRateEl.style.color = totalFloatProfitRate >= 0 ? '#ff4d4f' : '#52c41a';
        
        // Ê∏≤ÊüìÂêÑÊùøÂùó
        let html = '';
        const isMobile = window.innerWidth <= 768;
        
        appData.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // ËÆ°ÁÆóÊùøÂùóÊÄªÊî∂Áõä„ÄÅÊåÅ‰ªìÊÄªÈ¢ùÂíåÊî∂ÁõäÁéá
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            let sectorTotalAsset = 0;
            let sectorTotalCost = 0;
            
            sectorData.funds.forEach(fund => {
                const marketValue = fund.share * fund.todayNav;
                const costValue = fund.share * fund.costNav;
                sectorTotalAsset += marketValue;
                sectorTotalCost += costValue;
            });
            
            const sectorHoldingProfit = sectorTotalAsset - sectorTotalCost;
            const sectorHoldingProfitRate = sectorTotalCost > 0 ? (sectorHoldingProfit / sectorTotalCost * 100) : 0;
            
            html += `
                <div class="pnl-sector" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header">
                        <div class="pnl-sector-name">
                            <span style="color:${sectorData.color}; font-size:20px;">‚óè</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-stats">
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                                </div>
                            </div>
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-asset">${Math.round(sectorTotalAsset).toLocaleString()}</div>
                                <div class="pnl-sector-rate" style="color: ${sectorHoldingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorHoldingProfitRate >= 0 ? '+' : ''}${sectorHoldingProfitRate.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            if (isMobile) {
                // ÊâãÊú∫Á´ØÔºö‰ΩøÁî®Êñ∞ÁöÑÂç°ÁâáÂºèÂ∏ÉÂ±Ä
                html += `<div class="pnl-mobile-list">`;
                
                sectorData.funds.forEach(fund => {
                    const totalMarketValue = fund.share * fund.todayNav;
                    const holdingProfit = totalMarketValue - (fund.share * fund.costNav);
                    const holdingProfitRate = (holdingProfit / (fund.share * fund.costNav)) * 100;
                    
                    html += `
                        <div class="pnl-mobile-item">
                            <div class="pnl-mobile-header">
                                <div class="pnl-mobile-fund-info">
                                    <div class="pnl-mobile-fund-name">${fund.name}</div>
                                    <div class="pnl-mobile-fund-code">${fund.code}</div>
                                </div>
                            </div>
                            <div class="pnl-mobile-data">
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">Êó•Êî∂Áõä</div>
                                    <div class="pnl-mobile-value" style="color: ${fund.dailyProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${fund.growthRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">ÊåÅ‰ªìÊî∂Áõä</div>
                                    <div class="pnl-mobile-value" style="color: ${holdingProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfit >= 0 ? '+' : ''}${holdingProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${holdingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfitRate >= 0 ? '+' : ''}${holdingProfitRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">ÊÄªÂ∏ÇÂÄº</div>
                                    <div class="pnl-mobile-value">${totalMarketValue.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                // PCÁ´ØÔºö‰øùÊåÅÂéüÊúâË°®Ê†ºÂ∏ÉÂ±Ä
                html += `
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>Âü∫Èáë‰ª£Á†Å</th>
                                <th>Âü∫ÈáëÂêçÁß∞</th>
                                <th>Âçï‰ΩçÂáÄÂÄº</th>
                                <th>Êó•Ê∂®ÂπÖ</th>
                                <th>ÊåÅ‰ªì‰ªΩÈ¢ù</th>
                                <th>‰ªäÊó•Êî∂Áõä</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sectorData.funds.forEach(fund => {
                    const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                    const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                    
                    html += `
                        <tr>
                            <td><span class="fund-code">${fund.code}</span></td>
                            <td><span class="fund-name">${fund.name}</span></td>
                            <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                            <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                            <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                            <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `</div>`;
        });
        
        contentEl.innerHTML = html;
    }

    // Âä†ËΩΩÂÆûÊó∂È¢Ñ‰º∞Êï∞ÊçÆÔºà‰ΩøÁî®Â§©Â§©Âü∫ÈáëÊé•Âè£Ôºâ
    function loadEstimate() {
        const loadingEl = document.getElementById('estimateLoading');
        const contentEl = document.getElementById('estimateContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // Êî∂ÈõÜÊâÄÊúâÂü∫Èáë
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">ÊöÇÊó†ÊåÅ‰ªìÂü∫Èáë</div>';
            return;
        }
        
        // ‰∏≤Ë°åËé∑ÂèñÊØèÂè™Âü∫ÈáëÁöÑ‰º∞ÁÆóÊï∞ÊçÆ
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // ÂÖ®ÈÉ®ÂÆåÊàêÔºåÊ∏≤ÊüìÁªìÊûú
                loadingEl.style.display = 'none';
                renderEstimate(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchEstimateDataFromTTFund(fund.code)
                .then(data => {
                    if (data.success) {
                        // ËÆ°ÁÆóÈ¢Ñ‰º∞Êî∂Áõä
                        const estimateNav = data.estimateNav;
                        const yesterdayNav = data.yesterdayNav;
                        const growthRate = parseFloat(data.growthRate) || 0;
                        const dailyProfit = fund.share * (estimateNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            estimateTime: data.estimateTime
                        });
                    }
                })
                .catch(err => {
                    console.error(`Ëé∑Âèñ ${fund.code} ‰º∞ÁÆóÊï∞ÊçÆÂ§±Ë¥•:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // Ëé∑ÂèñÂ§©Â§©Âü∫Èáë‰º∞ÁÆóÊï∞ÊçÆÔºàÁã¨Á´ãÁöÑJSONPÂ§ÑÁêÜÔºâ
    function fetchEstimateDataFromTTFund(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const callbackName = 'ttfund_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            // ÂàõÂª∫‰∏¥Êó∂ÂõûË∞ÉÂáΩÊï∞
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                cleanup();
                
                try {
                    if (data && data.fundcode) {
                        const estimateNav = parseFloat(data.gsz) || 0;
                        const yesterdayNav = parseFloat(data.dwjz) || 0;
                        const growthRate = data.gszzl || '0';
                        const estimateTime = data.gztime || '';
                        
                        resolve({
                            success: true,
                            code: code,
                            estimateNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            estimateTime: estimateTime
                        });
                    } else {
                        reject(new Error('Invalid data'));
                    }
                } catch (e) {
                    reject(e);
                }
            };

            function cleanup() {
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            // Âä´ÊåÅjsonpgzÂõûË∞É
            const originalJsonpgz = window.jsonpgz;
            window.jsonpgz = function(data) {
                window[callbackName](data);
                // ÊÅ¢Â§çÂéüÂõûË∞É
                if (originalJsonpgz) {
                    window.jsonpgz = originalJsonpgz;
                }
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // Ê∏≤ÊüìÂÆûÊó∂È¢Ñ‰º∞
    function renderEstimate(results) {
        const contentEl = document.getElementById('estimateContent');
        
        // ÊåâÊùøÂùóÂàÜÁªÑ
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // ËÆ°ÁÆóÊÄªÊî∂Áõä
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
        });
        
        // Êõ¥Êñ∞È°∂ÈÉ®Ê±áÊÄª
        const totalPnlEl = document.getElementById('totalEstimatePnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        document.getElementById('estimateProfitCount').textContent = profitCount;
        document.getElementById('estimateLossCount').textContent = lossCount;
        
        // Ê∏≤ÊüìÂêÑÊùøÂùó
        let html = '';
        const isMobile = window.innerWidth <= 768;
        
        appData.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // ËÆ°ÁÆóÊùøÂùóÊÄªÊî∂Áõä„ÄÅÊåÅ‰ªìÊÄªÈ¢ùÂíåÊî∂ÁõäÁéá
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            let sectorTotalAsset = 0;
            let sectorTotalCost = 0;
            
            sectorData.funds.forEach(fund => {
                const marketValue = fund.share * fund.todayNav;
                const costValue = fund.share * fund.costNav;
                sectorTotalAsset += marketValue;
                sectorTotalCost += costValue;
            });
            
            const sectorHoldingProfit = sectorTotalAsset - sectorTotalCost;
            const sectorHoldingProfitRate = sectorTotalCost > 0 ? (sectorHoldingProfit / sectorTotalCost * 100) : 0;
            
            html += `
                <div class="pnl-sector" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header">
                        <div class="pnl-sector-name">
                            <span style="color:${sectorData.color}; font-size:20px;">‚óè</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-stats">
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                                </div>
                            </div>
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-asset">${Math.round(sectorTotalAsset).toLocaleString()}</div>
                                <div class="pnl-sector-rate" style="color: ${sectorHoldingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorHoldingProfitRate >= 0 ? '+' : ''}${sectorHoldingProfitRate.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
            `;
            
            if (isMobile) {
                // ÊâãÊú∫Á´ØÔºö‰ΩøÁî®Êñ∞ÁöÑÂç°ÁâáÂºèÂ∏ÉÂ±Ä
                html += `<div class="pnl-mobile-list">`;
                
                sectorData.funds.forEach(fund => {
                    const totalMarketValue = fund.share * fund.todayNav;
                    const holdingProfit = totalMarketValue - (fund.share * fund.costNav);
                    const holdingProfitRate = (holdingProfit / (fund.share * fund.costNav)) * 100;
                    
                    html += `
                        <div class="pnl-mobile-item">
                            <div class="pnl-mobile-header">
                                <div class="pnl-mobile-fund-info">
                                    <div class="pnl-mobile-fund-name">${fund.name}</div>
                                    <div class="pnl-mobile-fund-code">${fund.code}</div>
                                </div>
                            </div>
                            <div class="pnl-mobile-data">
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">Êó•Êî∂Áõä</div>
                                    <div class="pnl-mobile-value" style="color: ${fund.dailyProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${fund.growthRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">ÊåÅ‰ªìÊî∂Áõä</div>
                                    <div class="pnl-mobile-value" style="color: ${holdingProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfit >= 0 ? '+' : ''}${holdingProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${holdingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfitRate >= 0 ? '+' : ''}${holdingProfitRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">ÊÄªÂ∏ÇÂÄº</div>
                                    <div class="pnl-mobile-value">${totalMarketValue.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                // PCÁ´ØÔºö‰øùÊåÅÂéüÊúâË°®Ê†ºÂ∏ÉÂ±Ä
                html += `
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>Âü∫Èáë‰ª£Á†Å</th>
                                <th>Âü∫ÈáëÂêçÁß∞</th>
                                <th>‰º∞ÁÆóÂáÄÂÄº</th>
                                <th>‰º∞ÁÆóÊ∂®ÂπÖ</th>
                                <th>ÊåÅ‰ªì‰ªΩÈ¢ù</th>
                                <th>È¢Ñ‰º∞Êî∂Áõä</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sectorData.funds.forEach(fund => {
                    const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                    const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                    
                    html += `
                        <tr>
                            <td><span class="fund-code">${fund.code}</span></td>
                            <td><span class="fund-name">${fund.name}</span></td>
                            <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                            <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                            <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                            <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `</div>`;
        });
        
        contentEl.innerHTML = html;
    }

    // --- Ê†∏ÂøÉËÆ°ÁÆóÔºöÂ§çÂà©ËÆ°ÁÆóÂô® ---
    function calcCompound() {
        const principal = parseFloat(document.getElementById('cpPrincipal').value) || 0;
        const rate = parseFloat(document.getElementById('cpRate').value) / 100 || 0;
        const years = parseFloat(document.getElementById('cpYears').value) || 1;

        // 1. ‰∏ÄÊ¨°ÊÄßÊäïÂÖ• (Lump Sum)
        // FV = P * (1+r)^n
        const finalLumpSum = principal * Math.pow((1 + rate), years);
        
        // 2. ÂÆöÊäï (DCA)
        // ÁõÆÊ†áÊòØÂú® Years Âπ¥ÂÜÖÔºåÁ¥ØËÆ°ÊäïÂÖ•Êú¨ÈáëËææÂà∞ principal
        // ÊØèÊúàÈúÄÊäïÂÖ• = principal / (years * 12)
        const monthlyContrib = principal / (years * 12);
        const monthlyRate = rate / 12;
        let dcaBalance = 0;
        
        // ÁîüÊàêÂõæË°®Êï∞ÊçÆ
        const labels = [];
        const dataLump = [];
        const dataDCA = [];
        
        let currentLump = principal;
        
        // ÂàùÂßãÁÇπ (Á¨¨0Âπ¥)
        labels.push('Start');
        dataLump.push(principal);
        dataDCA.push(0);

        // ÊåâÂπ¥Ëø≠‰ª£ËÆ°ÁÆó
        for (let y = 1; y <= years; y++) {
            // Lump Sum Â¢ûÈïø
            currentLump = currentLump * (1 + rate);
            dataLump.push(currentLump);

            // DCA Â¢ûÈïø (ÊåâÊúàÂ§çÂà©Á¥ØÂä† 12Ê¨°)
            for(let m=0; m<12; m++) {
                dcaBalance = (dcaBalance + monthlyContrib) * (1 + monthlyRate);
            }
            dataDCA.push(dcaBalance);
            labels.push(`Year ${y}`);
        }

        // Êõ¥Êñ∞UI
        document.getElementById('resLumpSum').innerText = "¬•" + Math.round(finalLumpSum).toLocaleString();
        document.getElementById('resDCA').innerText = "¬•" + Math.round(dcaBalance).toLocaleString();
        document.getElementById('cpMonthlyInput').innerText = "¬•" + Math.round(monthlyContrib).toLocaleString();

        // ÁªòÂà∂ÂõæË°®
        renderCompoundChart(labels, dataLump, dataDCA);
    }

    function renderCompoundChart(labels, dataA, dataB) {
        const ctx = document.getElementById('compoundChart').getContext('2d');
        
        if (compoundChart) {
            compoundChart.destroy(); // ÈîÄÊØÅÊóßÂõæË°®
        }

        compoundChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‰∏ÄÊ¨°ÊÄßÊäïÂÖ• (ÊøÄËøõ)',
                        data: dataA,
                        borderColor: '#faad14', // Ê©ôËâ≤
                        backgroundColor: 'rgba(250, 173, 20, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'ÂÆöÊäïÁßØÁ¥Ø (Á®≥ÂÅ•)',
                        data: dataB,
                        borderColor: '#1890ff', // ËìùËâ≤
                        backgroundColor: 'rgba(24, 144, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // --- ÂõæË°®ÂàùÂßãÂåñ (ÂÜçÂπ≥Ë°°) ---
    function initChart() {
        const ctx = document.getElementById('assetChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%', 
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true, 
                            padding: 15,
                            font: { size: 11 }
                        }
                    } 
                }
            }
        });
    }

    // --- Ê∏≤ÊüìÈÄªËæë (ÂÆöÊäïÈÉ®ÂàÜ) ---
    function renderApp() {
        document.getElementById('totalGoal').value = appData.totalGoal;
        document.getElementById('months').value = appData.months;

        const container = document.getElementById('sectors-container');
        container.innerHTML = ''; 

        appData.sectors.forEach(sector => {
            const sectorHTML = buildSectorHTML(sector);
            container.insertAdjacentHTML('beforeend', sectorHTML);
            
            const tbody = document.getElementById(`tbody-${sector.id}`);
            sector.funds.forEach(fund => {
                tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(sector.id, fund));
            });
        });

        reCalcView(); 
    }

    function buildSectorHTML(sector) {
        return `
        <div class="sector-card" id="${sector.id}" style="border-top-color: ${sector.color}">
            <div class="card-header">
                <div class="header-left">
                    <div class="tool-bar">
                        <input type="color" class="color-picker" value="${sector.color}" onchange="updateSectorColor('${sector.id}', this.value)" title="‰øÆÊîπÈ¢úËâ≤">
                    </div>
                    <input type="text" class="sector-name-input" value="${sector.name}" onchange="updateSectorName('${sector.id}', this.value)">
                    <select class="strategy-tag" onchange="updateSectorStrategy('${sector.id}', this.value)" title="ÂÆöÊäïÁ≠ñÁï•">
                        <option value="sip" ${sector.strategy === 'sip' ? 'selected' : ''}>ÊØèÊó•ÂÆöÊäï</option>
                        <option value="fill" ${sector.strategy === 'fill' ? 'selected' : ''}>‰∏ÄÊ¨°ÊÄßË°•‰ªì</option>
                    </select>
                </div>
                <div class="header-right">
                    <span class="ratio-label">ÁõÆÊ†áÂç†ÊØî:</span>
                    <input type="number" class="ratio-input sec-weight" value="${sector.weight}" onchange="calcAll()"> %
                    <span class="progress-mini curr-ratio-text">(ÂÆåÊàêÂ∫¶ 0%)</span>
                    <button class="btn-icon" onclick="deleteSector('${sector.id}')" title="Âà†Èô§ÊùøÂùó">√ó</button>
                </div>
            </div>
            <div class="table-wrap">
                <table class="fund-table">
                    <thead>
                        <tr>
                            <th width="20%">Âü∫ÈáëÂêçÁß∞</th><th width="12%">‰ª£Á†Å</th><th width="12%">‰ªΩÈ¢ù</th><th width="10%">ÊàêÊú¨</th><th width="10%">ÂáÄÂÄº</th><th width="8%">ÊùøÂùóÂÜÖÂç†ÊØî%</th><th width="12%">Â∏ÇÂÄº/Áõà‰∫è</th><th width="15%" style="text-align:right">‰ªäÊó•Âª∫ËÆÆÂÆöÊäï</th><th width="3%"></th>
                        </tr>
                    </thead>
                    <tbody class="fund-list" id="tbody-${sector.id}"></tbody>
                </table>
            </div>
            <button class="btn-add-fund" onclick="addFundToSector('${sector.id}')">+ Ê∑ªÂä†Âü∫Èáë</button>
        </div>
        `;
    }

    function buildFundRowHTML(sectorId, fund) {
        return `
            <tr>
                <td><input type="text" class="tb-input f-name" value="${fund.name}" onchange="calcAll()"></td>
                <td><input type="text" class="tb-input f-code" value="${fund.code}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-share" value="${fund.share}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-cost" value="${fund.cost}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-nav" value="${fund.nav}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input tb-sm f-percent" value="${fund.percent}" onchange="calcAll()"></td>
                <td>
                    <div class="val-display">0</div>
                    <div class="pf-sub">--</div>
                </td>
                <td style="text-align:right"><span class="result-pill">¬•0</span></td>
                <td style="text-align:center"><button class="btn-icon" onclick="delRow(this)">√ó</button></td>
            </tr>
        `;
    }

    // --- ‰∫§‰∫í‰∏éËÆ°ÁÆó ---

    function createNewSector() {
        const newId = 'sec_' + Date.now();
        const newSector = {
            id: newId, name: 'Êñ∞ÊùøÂùó', color: '#999999', weight: 0, strategy: 'sip',
            funds: [{ name: 'Êñ∞Âü∫Èáë', code: '', share: 0, cost: 0, nav: 1.0, percent: 100 }]
        };
        appData.sectors.push(newSector);
        
        const container = document.getElementById('sectors-container');
        container.insertAdjacentHTML('beforeend', buildSectorHTML(newSector));
        const tbody = document.getElementById(`tbody-${newId}`);
        tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(newId, newSector.funds[0]));
        
        saveToLocal();
    }

    function deleteSector(id) {
        if(!confirm('Á°ÆÂÆöÂà†Èô§ËØ•ÊùøÂùóÂêóÔºü')) return;
        appData.sectors = appData.sectors.filter(s => s.id !== id);
        document.getElementById(id).remove();
        calcAll();
    }

    function addFundToSector(sectorId) {
        const emptyFund = { name: '', code: '', share: 0, cost: 0, nav: 1.0, percent: 0 };
        document.getElementById(`tbody-${sectorId}`).insertAdjacentHTML('beforeend', buildFundRowHTML(sectorId, emptyFund));
        calcAll();
    }

    function delRow(btn) {
        btn.closest('tr').remove();
        calcAll();
    }

    function updateSectorColor(id, color) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.color = color;
        document.getElementById(id).style.borderTopColor = color;
        calcAll(); // Êõ¥Êñ∞ÂõæË°®È¢úËâ≤
    }
    
    function updateSectorName(id, val) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.name = val;
        calcAll(); // Êõ¥Êñ∞Ë°®Ê†ºÂêçÁß∞
    }
    
    function updateSectorStrategy(id, val) {
        const sector = appData.sectors.find(s => s.id === id);
        if(sector) sector.strategy = val;
        calcAll();
    }

    function calcAll() {
        // 1. ÂêåÊ≠•È°∂ÈÉ®
        appData.totalGoal = parseFloat(document.getElementById('totalGoal').value) || 0;
        appData.months = parseFloat(document.getElementById('months').value) || 24;
        const days = appData.months * 21.5;

        let currentTotalAsset = 0;
        let totalProfit = 0;
        
        const chartLabels = [];
        const chartData = [];
        const chartColors = [];
        const rebalanceData = [];

        // 2. ÈÅçÂéÜÊùøÂùó
        appData.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if (!card) return;

            sector.weight = parseFloat(card.querySelector('.sec-weight').value) || 0;
            
            let sectorCurrentVal = 0;
            const newFundsList = [];

            const rows = card.querySelectorAll('.fund-list tr');
            rows.forEach(row => {
                const name = row.querySelector('.f-name').value;
                const code = row.querySelector('.f-code').value;
                const share = parseFloat(row.querySelector('.f-share').value) || 0;
                const cost = parseFloat(row.querySelector('.f-cost').value) || 0;
                const nav = parseFloat(row.querySelector('.f-nav').value) || 0;
                const percent = parseFloat(row.querySelector('.f-percent').value) || 0;

                newFundsList.push({ name, code, share, cost, nav, percent });

                const marketVal = share * nav;
                const profit = (nav - cost) * share;

                currentTotalAsset += marketVal;
                totalProfit += profit;
                sectorCurrentVal += marketVal;

                // Êõ¥Êñ∞Ë°åUI
                row.querySelector('.val-display').innerText = Math.round(marketVal).toLocaleString();
                const pfEl = row.querySelector('.pf-sub');
                pfEl.innerText = (profit>=0?'+':'') + Math.round(profit).toLocaleString();
                pfEl.className = 'pf-sub ' + (profit>=0 ? 'pf-pos' : 'pf-neg');
            });

            sector.funds = newFundsList;
            sector._tempCurrentVal = sectorCurrentVal;
            
            // Êî∂ÈõÜÂõæË°®‰∏éÂÜçÂπ≥Ë°°Êï∞ÊçÆ
            chartLabels.push(sector.name);
            chartData.push(sectorCurrentVal);
            chartColors.push(sector.color);
            rebalanceData.push({
                name: sector.name,
                color: sector.color,
                currentVal: sectorCurrentVal,
                targetRate: sector.weight
            });
        });

        // 3. Êõ¥Êñ∞È°∂ÈÉ®ÁúãÊùø
        const remainToInvest = appData.totalGoal - currentTotalAsset;
        document.getElementById('currTotalAsset').innerText = Math.round(currentTotalAsset).toLocaleString();
        document.getElementById('remainToInvest').innerText = Math.round(remainToInvest).toLocaleString();
        
        const pfDisplay = document.getElementById('totalProfitDisplay');
        pfDisplay.innerHTML = `<span style="font-size:16px; color:${totalProfit>=0?'#ff4d4f':'#52c41a'}">ÊµÆÁõà ${(totalProfit>=0?'+':'')}${Math.round(totalProfit).toLocaleString()}</span>`;
        document.getElementById('overBudgetWarning').style.display = currentTotalAsset > appData.totalGoal ? 'block' : 'none';

        // 4. Êõ¥Êñ∞ÂõæË°®‰∏éÂÜçÂπ≥Ë°°Ë°®
        updateDashboard(chartLabels, chartData, chartColors, rebalanceData, currentTotalAsset);

        // 5. ËÆ°ÁÆóÂÆöÊäïÁº∫Âè£
        appData.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if(!card) return;

            const targetSectorVal = appData.totalGoal * (sector.weight / 100);
            const ratio = targetSectorVal > 0 ? (sector._tempCurrentVal / targetSectorVal * 100) : 0;
            card.querySelector('.curr-ratio-text').innerText = `(ÂÆåÊàêÂ∫¶ ${ratio.toFixed(1)}%)`;

            const rows = card.querySelectorAll('.fund-list tr');
            rows.forEach((row, idx) => {
                const fund = sector.funds[idx];
                const fundCurrentVal = fund.share * fund.nav;
                const fundTargetVal = appData.totalGoal * (sector.weight/100) * (fund.percent/100);
                const gap = fundTargetVal - fundCurrentVal;

                const pill = row.querySelector('.result-pill');
                if (gap > 0) {
                    let amount = 0;
                    if (sector.strategy === 'fill') amount = gap;
                    else amount = gap / days;
                    
                    pill.className = 'result-pill';
                    pill.innerText = `¬•${Math.round(amount).toLocaleString()}`;
                } else {
                    pill.className = 'result-pill res-stop';
                    pill.innerText = 'ÊöÇÂÅú';
                }
            });
        });

        saveToLocal();
    }

    // --- Êõ¥Êñ∞ÂõæË°®‰∏éÂÜçÂπ≥Ë°°Ë°® ---
    function updateDashboard(labels, data, colors, rbData, totalAsset) {
        // Êõ¥Êñ∞ÂõæË°®
        if (myChart) {
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = data;
            myChart.data.datasets[0].backgroundColor = colors;
            myChart.update();
        }

        // Êõ¥Êñ∞Ë°®Ê†º
        const tbody = document.getElementById('rebalanceBody');
        tbody.innerHTML = '';
        
        rbData.forEach(item => {
            const actualRate = totalAsset > 0 ? (item.currentVal / totalAsset * 100) : 0;
            const diffRate = actualRate - item.targetRate;
            
            const targetVal = totalAsset * (item.targetRate / 100);
            const actionAmount = targetVal - item.currentVal; // Ê≠£Êï∞=ÈúÄ‰π∞ÂÖ•(Á∫¢Ëâ≤)ÔºåË¥üÊï∞=ÈúÄÂçñÂá∫(ÁªøËâ≤)

            let statusHtml = '<span class="tag-status st-ok">ËææÊ†á</span>';
            let actionHtml = '-';

            // ÈòàÂÄº 2%
            if (diffRate > 2) {
                statusHtml = `<span class="tag-status st-over">Ë∂ÖÈÖç ${diffRate.toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-sell">ÂçñÂá∫ ¬•${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            } else if (diffRate < -2) {
                statusHtml = `<span class="tag-status st-under">‰ΩéÈÖç ${Math.abs(diffRate).toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-buy">‰π∞ÂÖ• ¬•${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            }

            const tr = `
                <tr>
                    <td><span style="color:${item.color}; font-weight:bold; margin-right:5px;">‚óè</span>${item.name}</td>
                    <td style="text-align:center; font-weight:bold;">${actualRate.toFixed(1)}%</td>
                    <td style="text-align:center; color:#999;">${item.targetRate}%</td>
                    <td style="text-align:center;">${statusHtml}</td>
                    <td style="text-align:right;">${actionHtml}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', tr);
        });
    }

    function reCalcView() { calcAll(); }

    function saveToLocal() {
        localStorage.setItem('smartSIP_data_v7', JSON.stringify(appData));
        // Ëá™Âä®‰øùÂ≠òÂà∞‰∫ëÁ´ØÔºà‰∏çÈòªÂ°ûUIÔºâ
        saveToCloud().catch(err => console.error('‰∫ëÁ´Ø‰øùÂ≠òÂ§±Ë¥•:', err));
    }

    // --- ËÅîÁΩëÂäüËÉΩÔºöÂêåÊ≠•Âü∫ÈáëÂÆûÈôÖÂáÄÂÄºÔºà‰ªÖ‰∏úÊñπË¥¢ÂØåÔºâ ---
    function syncAllFundNav() {
        const statusEl = document.getElementById('syncStatus');
        statusEl.innerHTML = '<span class="sync-status sync-loading">üîÑ Ê≠£Âú®ÂêåÊ≠•ÂáÄÂÄºÊï∞ÊçÆ...</span>';
        
        let totalFunds = 0;
        let successCount = 0;
        let errorCount = 0;
        const fundCodes = [];

        // Êî∂ÈõÜÊâÄÊúâÂü∫Èáë‰ª£Á†Å
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '') {
                    totalFunds++;
                    fundCodes.push({ code: fund.code, sectorId: sector.id });
                }
            });
        });

        if (totalFunds === 0) {
            statusEl.innerHTML = '<span class="sync-status sync-error">‚ö†Ô∏è Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÁöÑÂü∫Èáë‰ª£Á†Å</span>';
            return;
        }

        // ‰∏≤Ë°åËØ∑Ê±ÇÔºåÈÅøÂÖçapidataÂÜ≤Á™Å
        let currentIndex = 0;
        
        function fetchNext() {
            if (currentIndex >= fundCodes.length) {
                // ÂÖ®ÈÉ®ÂÆåÊàê
                if (errorCount === 0) {
                    statusEl.innerHTML = `<span class="sync-status sync-success">‚úÖ ÊàêÂäüÂêåÊ≠• ${successCount} Âè™Âü∫ÈáëÂáÄÂÄº</span>`;
                } else {
                    statusEl.innerHTML = `<span class="sync-status sync-error">‚ö†Ô∏è ÂêåÊ≠•ÂÆåÊàêÔºöÊàêÂäü ${successCount} Âè™ÔºåÂ§±Ë¥• ${errorCount} Âè™</span>`;
                }
                setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                calcAll();
                return;
            }
            
            const item = fundCodes[currentIndex];
            currentIndex++;
            
            fetchActualNavFromEastmoney(item.code)
                .then(result => {
                    if (result.success) {
                        successCount++;
                        updateFundNavInUI(result.code, result.nav, result.time);
                    } else {
                        errorCount++;
                    }
                })
                .catch(() => {
                    errorCount++;
                })
                .finally(() => {
                    // ÁªßÁª≠‰∏ã‰∏Ä‰∏™
                    setTimeout(fetchNext, 300); // Âª∂Ëøü300msÈÅøÂÖçËØ∑Ê±ÇËøáÂø´
                });
        }
        
        fetchNext();
    }

    // ‰ªé‰∏úÊñπË¥¢ÂØåËé∑ÂèñÂÆûÈôÖÂáÄÂÄº
    function fetchActualNavFromEastmoney(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const uniqueId = 'apidata_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (window[uniqueId]) {
                    delete window[uniqueId];
                }
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                // Áªô‰∏ÄÁÇπÊó∂Èó¥ËÆ©ËÑöÊú¨ÊâßË°å
                setTimeout(() => {
                    try {
                        // ‰∏úÊñπË¥¢ÂØåÊé•Âè£‰ºöËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè apidata
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            
                            // Á´ãÂç≥‰øùÂ≠òÂà∞ÂîØ‰∏ÄÂèòÈáèÔºåÈÅøÂÖçË¢´Ë¶ÜÁõñ
                            window[uniqueId] = JSON.parse(JSON.stringify(window.apidata));
                            
                            // Ëß£ÊûêHTMLË°®Ê†º
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length > 0) {
                                const firstRow = rows[0];
                                const cells = firstRow.querySelectorAll('td');
                                
                                if (cells.length >= 2) {
                                    const date = cells[0].textContent.trim();
                                    const nav = parseFloat(cells[1].textContent.trim()) || 0;
                                    
                                    clearTimeout(timeout);
                                    cleanup();
                                    resolve({
                                        success: true,
                                        code: code,
                                        nav: nav,
                                        time: date
                                    });
                                    return;
                                }
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=1&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // Êõ¥Êñ∞UI‰∏≠ÁöÑÂáÄÂÄº
    function updateFundNavInUI(code, nav, time) {
        // Êõ¥Êñ∞appData
        appData.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code === code) {
                    fund.nav = nav;
                }
            });
        });

        // Êõ¥Êñ∞UIËæìÂÖ•Ê°Ü
        document.querySelectorAll('.f-code').forEach(input => {
            if (input.value === code) {
                const row = input.closest('tr');
                const navInput = row.querySelector('.f-nav');
                navInput.value = nav.toFixed(4);
                navInput.style.color = '#52c41a'; // ÁªøËâ≤Ë°®Á§∫ÂÆûÈôÖÂáÄÂÄº
                navInput.title = `ÂÆûÈôÖÂáÄÂÄº (${time})`;
            }
        });

        saveToLocal();
    }

    function exportData() {
        const str = localStorage.getItem('smartSIP_data_v7');
        if (!str) return alert("Êó†Êï∞ÊçÆ");
        const blob = new Blob([str], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ÊäïËµÑÁ≠ñÁï•V7_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.sectors) throw new Error();
                appData = json;
                saveToLocal();
                renderApp();
                alert("ÈÖçÁΩÆÂ∑≤ÊÅ¢Â§ç");
            } catch(e){ alert("Êñá‰ª∂Ê†ºÂºèÈîôËØØ"); }
        };
        r.readAsText(f);
        input.value = '';
    }
</script>

</body>
</html>
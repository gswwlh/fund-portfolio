<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能定投系统 (V8 组合版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --primary: #1890ff;       
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e8e8e8;
            
            /* 语义色 */
            --pos: #ff4d4f; /* 涨/买入/超配 */
            --neg: #52c41a; /* 跌/卖出/低配 */
            --warn: #faad14; 
            
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* --- 1. 顶部深蓝指挥舱 --- */
        .dashboard-config {
            background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
            color: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(30, 42, 58, 0.3);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .config-group { display: flex; gap: 30px; align-items: center; }
        .config-item label { display: block; font-size: 13px; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
        
        .dash-input {
            background: white; border: none; color: #333;
            padding: 10px 15px; border-radius: 6px; font-size: 20px; font-weight: bold;
            width: 180px; font-family: 'Consolas', monospace;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .dash-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); }

        .summary-group { display: flex; gap: 40px; text-align: right; }
        .summary-label { font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase; }
        .summary-val { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: -0.5px; line-height: 1.2;}
        .summary-sub { font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 4px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 25px;}
        .btn-dash {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-dash:hover { background: rgba(255,255,255,0.3); }
        .btn-toggle-active { background: #fff !important; color: #1867c0 !important; font-weight: bold; }

        /* --- 2. 资产分析看板 (默认隐藏) --- */
        .analysis-dashboard {
            display: none; 
            grid-template-columns: 400px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch; 
        }
        @media (max-width: 900px) { .analysis-dashboard { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 20px; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 320px;
        }
        .chart-container-inner { width: 100%; height: 100%; max-height: 300px; position: relative; }

        .rebalance-card {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box;
        }
        .rb-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #333; }
        
        .rb-table { width: 100%; border-collapse: collapse; font-size: 14px; flex: 1; }
        .rb-table th { text-align: left; padding: 12px 10px; background: #fafafa; color: #888; font-weight: 600; border-bottom: 1px solid #eee; }
        .rb-table td { padding: 14px 10px; border-bottom: 1px solid #f5f5f5; color: #333; font-weight: 500; }
        .rb-table tr:last-child td { border-bottom: none; }
        
        .tag-status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 800; }
        .st-over { background: #fff1f0; color: var(--pos); border: 1px solid #ffa39e; }
        .st-under { background: #fffbe6; color: var(--warn); border: 1px solid #ffe58f; }
        .st-ok { background: #f6ffed; color: var(--neg); border: 1px solid #b7eb8f; }

        .rb-action { font-family: 'Consolas', monospace; font-weight: 800; font-size: 15px;}
        .act-sell { color: var(--neg); } 
        .act-buy { color: var(--pos); }  
        
        .rb-tip { margin-top: 15px; padding-top: 15px; font-size: 12px; color: #999; border-top: 1px dashed #eee; line-height: 1.6; }

        /* --- 3. 复利计算器模块 (新增) --- */
        .compound-dashboard {
            display: none; /* 默认隐藏 */
            grid-template-columns: 350px 1fr;
            gap: 25px;
            margin-bottom: 30px;
            align-items: stretch;
        }
        @media (max-width: 900px) { .compound-dashboard { grid-template-columns: 1fr; } }

        .compound-inputs {
            background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow);
            padding: 25px; display: flex; flex-direction: column; gap: 20px;
        }
        .cp-title { font-size: 18px; font-weight: 800; color: #333; margin-bottom: 5px; }
        
        .input-row label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .input-row input { 
            width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px;
            font-size: 16px; font-weight: bold; box-sizing: border-box;
        }
        .input-row input:focus { border-color: var(--primary); outline: none; }

        .result-box {
            background: #f9f9f9; padding: 15px; border-radius: 6px; border: 1px solid #eee; margin-top: 10px;
        }
        .res-label { font-size: 12px; color: #888; text-transform: uppercase; }
        .res-val { font-size: 24px; font-weight: 800; margin-top: 2px; }
        .res-val.type-a { color: #faad14; } /* 橙色 - 一次性 */
        .res-val.type-b { color: #1890ff; } /* 蓝色 - 定投 */

        /* --- 今日盈亏模块 --- */
        .daily-pnl-dashboard {
            display: block;
            margin-bottom: 15px;
        }

        /* 实时预估默认隐藏 */
        #estimatePanel {
            display: none;
        }

        .pnl-card {
            background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(30, 42, 58, 0.3);
            padding: 20px 30px;
        }

        .pnl-header {
            color: white;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pnl-title {
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .pnl-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .pnl-summary-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .pnl-label {
            font-size: 12px;
            color: rgba(255,255,255,0.85);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .pnl-value {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: white;
            line-height: 1;
        }

        .pnl-count {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-count.profit {
            color: #ff4d4f;
        }

        .pnl-count.loss {
            color: #52c41a;
        }

        .pnl-count-total {
            font-size: 32px;
            font-weight: 800;
            color: white;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-value-large {
            font-size: 28px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #fff;
            line-height: 1;
        }

        .pnl-rate {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: rgba(255,255,255,0.9);
            margin-top: 5px;
        }

        .pnl-loading {
            padding: 60px;
            text-align: center;
            color: rgba(255,255,255,0.8);
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pnl-content {
            padding: 0;
            margin-top: 15px;
            background: transparent;
        }

        .pnl-sector {
            border-top: 5px solid #ccc;
            margin-bottom: 15px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            background: white;
        }

        .pnl-sector:last-child {
            margin-bottom: 0;
        }

        .pnl-sector-header {
            background: #fafafa;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
            transition: background 0.2s;
            cursor: pointer;
        }

        .pnl-sector-header:hover {
            background: #f0f0f0;
        }

        .pnl-sector-name {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pnl-sector-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .pnl-sector-stat {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .pnl-sector-total {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-sector-asset {
            font-size: 16px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
            color: #333;
            line-height: 1;
        }

        .pnl-sector-rate {
            font-size: 13px;
            font-weight: 600;
            font-family: 'Consolas', monospace;
            line-height: 1;
        }

        .pnl-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .pnl-table th {
            background: #f9f9f9;
            padding: 12px 15px;
            text-align: left;
            font-size: 12px;
            color: #888;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .pnl-table th:nth-child(1) { width: 10%; } /* 基金代码 */
        .pnl-table th:nth-child(2) { width: 25%; } /* 基金名称 */
        .pnl-table th:nth-child(3) { width: 12%; } /* 单位净值 */
        .pnl-table th:nth-child(4) { width: 12%; } /* 日涨幅 */
        .pnl-table th:nth-child(5) { width: 15%; } /* 持仓份额 */
        .pnl-table th:nth-child(6) { width: 16%; text-align: right; } /* 今日收益 */

        .pnl-table td:nth-child(1) { width: 10%; }
        .pnl-table td:nth-child(2) { width: 25%; }
        .pnl-table td:nth-child(3) { width: 12%; }
        .pnl-table td:nth-child(4) { width: 12%; }
        .pnl-table td:nth-child(5) { width: 15%; }
        .pnl-table td:nth-child(6) { width: 16%; text-align: right; }

        .pnl-table td {
            padding: 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 14px;
            color: #333;
        }

        .pnl-table tr:last-child td {
            border-bottom: none;
        }

        .pnl-table tr:hover {
            background: #fafafa;
        }

        .fund-code {
            font-family: 'Consolas', monospace;
            color: #666;
            font-size: 13px;
        }

        .fund-name {
            font-weight: 600;
            color: #333;
        }

        .nav-value {
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }

        .growth-rate {
            font-family: 'Consolas', monospace;
            font-weight: 700;
            font-size: 15px;
        }

        .growth-positive {
            color: #ff4d4f;
        }

        .growth-negative {
            color: #52c41a;
        }

        .growth-zero {
            color: #999;
        }

        .share-amount {
            font-family: 'Consolas', monospace;
            color: #666;
        }

        .daily-profit {
            font-family: 'Consolas', monospace;
            font-weight: 800;
            font-size: 16px;
        }

        .profit-positive {
            color: #ff4d4f;
        }

        .profit-negative {
            color: #52c41a;
        }

        .profit-zero {
            color: #999;
        }

        /* 手机端卡片式布局 */
        .pnl-mobile-list {
            display: none;
        }

        .pnl-mobile-item {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .pnl-mobile-item:last-child {
            border-bottom: none;
        }

        /* 移动端黑色主题覆盖 */
        @media (max-width: 768px) {
            .pnl-mobile-item {
                background: rgba(255, 255, 255, 0.03);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
        }

        .pnl-mobile-header {
            margin-bottom: 12px;
        }

        .pnl-mobile-fund-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pnl-mobile-fund-name {
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        .pnl-mobile-fund-code {
            font-size: 12px;
            color: #999;
        }

        .pnl-mobile-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .pnl-mobile-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .pnl-mobile-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 6px;
        }

        .pnl-mobile-value {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #333;
            line-height: 1.2;
        }

        /* 移动端黑色主题覆盖 - 卡片文字 */
        @media (max-width: 768px) {
            .pnl-mobile-fund-name {
                color: #e8eaf0;
            }
            
            .pnl-mobile-fund-code {
                color: rgba(255, 255, 255, 0.5);
            }
            
            .pnl-mobile-label {
                color: rgba(255, 255, 255, 0.6);
            }
            
            .pnl-mobile-value {
                color: #ffffff;
            }
        }

        .pnl-mobile-sub {
            font-size: 13px;
            font-weight: 600;
            font-family: 'Consolas', monospace;
            margin-top: 2px;
        }

        /* --- 4. 板块卡片 --- */
        .sector-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border-top: 5px solid #ccc;
            position: relative;
        }
        
        .card-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; background: #fff; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .sector-name-input { font-size: 18px; font-weight: 800; color: #333; border: 1px solid transparent; background: transparent; width: 260px; padding: 4px; border-radius: 4px; }
        .sector-name-input:hover { border-color: #eee; }
        .sector-name-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        .strategy-tag { font-size: 12px; padding: 3px 8px; border-radius: 10px; background: #f5f5f5; color: #666; border: 1px solid #e8e8e8; cursor: pointer; }

        .header-right { display: flex; align-items: center; gap: 15px; background: #f9f9f9; padding: 8px 15px; border-radius: 6px; }
        .ratio-label { font-size: 13px; color: #666; }
        .ratio-input { width: 40px; text-align: center; border: 1px solid #d9d9d9; padding: 4px; border-radius: 4px; font-weight: bold; color: #333; background: #fff; }
        .ratio-input:focus { border-color: var(--primary); outline: none; }
        
        .progress-mini { font-size: 12px; color: #999; margin-left: 10px; }

        .tool-bar { display: flex; gap: 5px; margin-right: 10px; }
        .color-picker { width: 20px; height: 20px; padding: 0; border: none; cursor: pointer; background: none; vertical-align: middle; }
        .btn-icon { border: none; background: none; cursor: pointer; font-size: 16px; color: #ccc; }
        .btn-icon:hover { color: #ff4d4f; }

        .table-wrap { padding: 10px 25px 25px 25px; }
        table { width: 100%; border-collapse: collapse; }
        
        .fund-table th { text-align: left; padding: 12px 10px; font-size: 12px; color: #888; font-weight: normal; border-bottom: 1px dashed #eee; }
        .fund-table td { padding: 15px 10px; border-bottom: 1px solid #f5f5f5; vertical-align: middle; font-size: 14px; }
        .fund-table tr:last-child td { border-bottom: none; }
        
        .tb-input { width: 100%; padding: 8px 10px; border: 1px solid #d9d9d9; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 14px; color: #333; transition: all 0.2s; box-sizing: border-box; }
        .tb-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2); }
        .tb-sm { width: 60px; text-align: center; }

        .result-pill { display: block; padding: 8px 15px; border-radius: 4px; font-family: 'Consolas', monospace; font-weight: 700; font-size: 16px; text-align: right; background: #e6f7ff; color: #1890ff; min-width: 90px; }
        .res-stop { background: #f5f5f5; color: #ccc; font-weight: normal; }
        
        .val-display { font-weight: bold; font-family: 'Consolas', monospace; color: #333; }
        .pf-pos { color: var(--pos); font-size: 12px; }
        .pf-neg { color: var(--neg); font-size: 12px; }

        .btn-add-fund { width: 100%; padding: 12px; border: 1px dashed #d9d9d9; background: #fafafa; color: #666; cursor: pointer; border-radius: 0 0 var(--radius) var(--radius); font-size: 13px; transition: 0.2s; }
        .btn-add-fund:hover { color: var(--primary); border-color: var(--primary); background: #fff; }

        .btn-add-sector { width: 100%; padding: 20px; border: 2px dashed #d9d9d9; border-radius: var(--radius); background: transparent; color: #999; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 40px; transition: 0.2s; }
        .btn-add-sector:hover { border-color: var(--primary); color: var(--primary); background: #f0faff; }

        .warning-box { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; padding: 12px; text-align: center; margin-bottom: 20px; border-radius: var(--radius); font-weight: 600; display: none; }
        
        /* 联网功能样式 */
        .sync-status { display: inline-block; margin-left: 10px; font-size: 12px; padding: 3px 8px; border-radius: 4px; }
        .sync-success { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
        .sync-error { background: #fff2f0; color: #ff4d4f; border: 1px solid #ffccc7; }
        .sync-loading { background: #e6f7ff; color: #1890ff; border: 1px solid #91d5ff; }

        /* --- 5. 底部策略卡片 --- */
        .strategy-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 40px; margin-bottom: 40px; }
        @media (max-width: 768px) { .strategy-footer { grid-template-columns: 1fr; } }

        .info-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #eee; }
        .info-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; }
        .strategy-list, .rules-list { padding-left: 0; list-style: none; margin: 0; }
        .strategy-list li, .rules-list li { margin-bottom: 15px; color: var(--text-sub); font-size: 14px; line-height: 1.6; }
        .strategy-list li strong, .rules-list li strong { color: #333; }
        
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .green { background: #52c41a; }
        .yellow { background: #faad14; }
        .red { background: #ff4d4f; }
        
        .highlight-text { color: #1890ff; font-weight: bold; background: #e6f7ff; padding: 2px 4px; border-radius: 4px; }

        /* --- 指数面板样式 --- */
        .index-dashboard {
            background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(30, 42, 58, 0.3);
        }

        .index-title {
            color: white;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .index-title span {
            flex: 0 0 auto;
        }

        .index-title button:first-of-type {
            margin-left: auto;
        }

        .index-refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .index-refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .index-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        @media (max-width: 1024px) {
            .index-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .index-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .index-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .index-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .index-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .index-value {
            color: white;
            font-size: 22px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            margin-bottom: 5px;
        }

        .index-change {
            font-size: 14px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }

        .index-change.positive {
            color: #ff6b6b;
        }

        .index-change.negative {
            color: #51cf66;
        }

        .index-change.zero {
            color: rgba(255, 255, 255, 0.7);
        }

        /* 移动端黑色主题 - 涨跌颜色增强 */
        @media (max-width: 768px) {
            .index-change.positive {
                color: #ff5757;
                text-shadow: 0 0 8px rgba(255, 87, 87, 0.3);
            }

            .index-change.negative {
                color: #51cf66;
                text-shadow: 0 0 8px rgba(81, 207, 102, 0.3);
            }
            
            .growth-positive,
            .profit-positive {
                color: #ff5757 !important;
            }
            
            .growth-negative,
            .profit-negative {
                color: #51cf66 !important;
            }
            
            .pnl-mobile-sub {
                font-weight: 600;
            }
        }

        /* --- 用户ID管理弹窗 --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 800;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .modal-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-value {
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #1890ff;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #d9d9d9;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-input:focus {
            border-color: #1890ff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #1890ff;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #40a9ff;
        }

        .modal-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        .modal-btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .modal-btn-danger:hover {
            background: #ff7875;
        }

        .copy-btn {
            padding: 6px 12px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #40a9ff;
        }

        .modal-hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* ========== 移动端优化 ========== */
        @media (max-width: 768px) {
            /* 禁用移动端点击高亮 */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }

            body {
                padding: 10px;
                background: #0a0e1a;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            /* 顶部配置面板 */
            .dashboard-config {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }

            .config-group {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .config-item {
                width: 100%;
            }

            .dash-input {
                width: 100%;
                font-size: 16px;
                padding: 12px;
            }

            .summary-group {
                flex-direction: column;
                gap: 15px;
                width: 100%;
            }

            .summary-item {
                text-align: left;
            }

            .summary-val {
                font-size: 24px;
            }

            /* 按钮组 */
            .btn-group {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn-dash {
                font-size: 11px;
                padding: 8px 10px;
                flex: 1 1 calc(50% - 4px);
                min-width: calc(50% - 4px);
            }

            /* 指数面板 */
            .index-dashboard {
                padding: 20px 15px;
                margin-bottom: 15px;
                border-radius: 12px;
                background: linear-gradient(135deg, #1a1f35 0%, #2d1b3d 100%);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .index-title {
                font-size: 16px;
                margin-bottom: 15px;
                font-weight: 700;
                color: #e8eaf0;
            }

            .index-refresh-btn {
                font-size: 12px;
                padding: 5px 10px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #e8eaf0;
            }

            .index-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .index-item {
                padding: 12px;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                transition: all 0.3s ease;
            }

            .index-name {
                font-size: 12px;
                margin-bottom: 6px;
                color: rgba(255, 255, 255, 0.7);
            }

            .index-value {
                font-size: 20px;
                margin-bottom: 4px;
                font-weight: 700;
                color: #ffffff;
            }

            .index-change {
                font-size: 13px;
                font-weight: 600;
            }

            /* 今日盈亏面板 */
            .daily-pnl-dashboard {
                margin-bottom: 15px;
            }

            .pnl-card {
                border-radius: 12px;
                padding: 15px;
                background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            .pnl-header {
                margin-bottom: 15px;
            }

            .pnl-title {
                font-size: 16px;
                font-weight: 700;
                color: #e8eaf0;
            }

            .pnl-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .pnl-summary-item {
                padding: 12px;
                background: rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .pnl-label {
                font-size: 11px;
                margin-bottom: 6px;
                color: rgba(255, 255, 255, 0.6);
            }

            .pnl-value,
            .pnl-count,
            .pnl-count-total {
                font-size: 24px;
                color: #ffffff;
            }

            .pnl-value-large {
                font-size: 22px;
                color: #ffffff;
            }

            .pnl-rate {
                font-size: 12px;
                margin-top: 4px;
            }

            .pnl-content {
                padding: 0;
                margin-top: 15px;
            }

            .pnl-sector {
                margin-bottom: 12px;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                overflow: hidden;
            }

            .pnl-sector-header {
                padding: 12px 15px;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                background: rgba(255, 255, 255, 0.03);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .pnl-sector-name {
                font-size: 15px;
                flex: 1;
                color: #e8eaf0;
            }

            .pnl-sector-stats {
                gap: 15px;
            }

            .pnl-sector-total {
                font-size: 18px;
                font-weight: 800;
                color: #ffffff;
            }

            .pnl-sector-asset {
                font-size: 15px;
                color: #b8bcc8;
            }

            .pnl-sector-rate {
                font-size: 12px;
            }

            /* 手机端：隐藏表格，显示卡片 */
            .pnl-table {
                display: none;
            }

            .pnl-mobile-list {
                display: block;
            }

            /* 表格优化 */
            .pnl-table {
                font-size: 12px;
            }

            .pnl-table th,
            .pnl-table td {
                padding: 10px 8px;
            }

            .fund-code {
                font-size: 12px;
            }

            .fund-name {
                font-size: 13px;
                font-weight: 600;
            }

            .nav-value,
            .growth-rate,
            .share-amount,
            .daily-profit {
                font-size: 13px;
            }

            /* 板块卡片 */
            .sector-card {
                margin-bottom: 15px;
            }

            .card-header {
                padding: 10px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                width: 100%;
            }

            .sector-name-input {
                font-size: 16px;
                width: 100%;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .table-wrap {
                padding: 10px 15px 15px 15px;
                overflow-x: auto;
            }

            .fund-table {
                min-width: 600px;
            }

            .fund-table th,
            .fund-table td {
                padding: 10px 5px;
                font-size: 12px;
            }

            .tb-input {
                padding: 6px 8px;
                font-size: 12px;
            }

            .result-pill {
                padding: 6px 10px;
                font-size: 14px;
                min-width: 70px;
            }

            /* 底部策略卡片 */
            .strategy-footer {
                margin-top: 20px;
                margin-bottom: 20px;
                gap: 15px;
            }

            .info-card {
                padding: 20px;
            }

            .info-title {
                font-size: 16px;
                margin-bottom: 15px;
            }

            .strategy-list li,
            .rules-list li {
                font-size: 13px;
                margin-bottom: 12px;
            }

            /* 用户ID管理弹窗 */
            .modal-overlay {
                background: rgba(0, 0, 0, 0.85);
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
                background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
                border: 1px solid rgba(255, 255, 255, 0.15);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            }

            .modal-title {
                font-size: 18px;
                color: #e8eaf0;
            }

            .modal-section {
                padding: 15px;
                margin-bottom: 20px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .modal-label {
                color: rgba(255, 255, 255, 0.7);
            }

            .modal-value {
                font-size: 12px;
                padding: 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: #64b5f6;
            }

            .copy-btn {
                width: 100%;
                background: rgba(100, 181, 246, 0.2);
                border: 1px solid rgba(100, 181, 246, 0.4);
                color: #64b5f6;
            }

            .modal-input {
                font-size: 14px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                color: #ffffff;
            }
            
            .modal-input::placeholder {
                color: rgba(255, 255, 255, 0.4);
            }
            
            .modal-hint {
                color: rgba(255, 255, 255, 0.5);
            }

            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .modal-btn {
                width: 100%;
                padding: 12px;
            }
            
            .modal-btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
            }
            
            .modal-btn-secondary {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #e8eaf0;
            }
            
            .modal-btn-danger {
                background: linear-gradient(135deg, #ff5757 0%, #ff4d4f 100%);
                border: none;
            }

            /* 隐藏不必要的元素 - 手机端只显示数据查看 */
            .dashboard-config,
            .analysis-dashboard,
            .compound-dashboard,
            .sector-card,
            .btn-add-sector,
            .strategy-footer,
            #overBudgetWarning,
            #rebalancePanel,
            #compoundPanel,
            #estimatePanel {
                display: none !important;
            }

            /* 用户ID显示 */
            #userIdDisplay {
                font-size: 10px;
                word-break: break-all;
            }

            #currentUserId {
                display: block;
                margin-top: 5px;
            }
        }

        /* 小屏手机优化 (< 480px) */
        @media (max-width: 480px) {
            body {
                background: #0a0e1a;
            }
            
            .dashboard-config {
                padding: 10px;
            }

            .summary-val {
                font-size: 20px;
            }

            .btn-dash {
                font-size: 10px;
                padding: 6px 8px;
            }

            .index-refresh-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .index-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .index-item {
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
            }

            .index-name {
                font-size: 11px;
            }

            .index-value {
                font-size: 18px;
            }

            .index-change {
                font-size: 12px;
            }

            .pnl-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .pnl-summary-item {
                padding: 10px;
                background: rgba(255, 255, 255, 0.08);
            }

            .pnl-label {
                font-size: 10px;
            }

            .pnl-value,
            .pnl-count,
            .pnl-count-total {
                font-size: 20px;
            }

            .pnl-value-large {
                font-size: 18px;
            }

            .pnl-rate {
                font-size: 11px;
            }

            .pnl-sector-name {
                font-size: 14px;
            }

            .pnl-sector-total {
                font-size: 18px;
            }

            .pnl-table {
                font-size: 10px;
            }

            .fund-table {
                min-width: 500px;
            }
        }

        /* ========================================
           组合功能样式
           ======================================== */
        
        /* 组合选择器容器 */
        .portfolio-selector {
            background: linear-gradient(135deg, #1e2a3a 0%, #2a1e3a 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            max-width: 100%;
            overflow: hidden;
        }
        
        .portfolio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .portfolio-title {
            font-size: 16px;
            font-weight: 700;
            color: #e8eaf0;
        }
        
        .btn-new-portfolio {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8eaf0;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-new-portfolio:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .portfolio-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            width: 100%;
            max-width: 100%;
        }
        
        .portfolio-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .portfolio-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .portfolio-card.active {
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        
        .portfolio-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .portfolio-card-name {
            font-size: 14px;
            font-weight: 600;
            color: #e8eaf0;
            flex: 1;
        }
        
        .portfolio-card-menu {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            line-height: 1;
        }
        
        .portfolio-card-menu:hover {
            color: #e8eaf0;
        }
        
        .portfolio-card-value {
            font-size: 18px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #ffffff;
            margin-bottom: 4px;
        }
        
        .portfolio-card-profit {
            font-size: 13px;
            font-weight: 700;
            font-family: 'Consolas', monospace;
        }
        
        .portfolio-card-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* ========================================
           折叠功能样式
           ======================================== */
        
        /* 组合折叠样式 */
        .portfolio-wrapper {
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .portfolio-wrapper.active {
            border: 2px solid #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }
        
        .portfolio-header-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }
        
        .portfolio-header-bar:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .portfolio-collapse-icon {
            font-size: 14px;
            color: #666;
            transition: transform 0.3s ease;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .portfolio-header-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 0;
        }
        
        .portfolio-name {
            font-size: 18px;
            font-weight: 800;
            color: #333;
        }
        
        .portfolio-stats {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            white-space: nowrap;
        }
        
        .stat-divider {
            color: #ccc;
        }
        
        .portfolio-value {
            font-size: 24px;
            font-weight: 800;
            font-family: 'Consolas', monospace;
            color: #1890ff;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .portfolio-menu-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .portfolio-menu-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        
        .portfolio-content {
            padding: 20px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        /* 板块折叠样式增强 */
        .card-header.collapsible {
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .card-header.collapsible:hover {
            background: #fafafa;
        }
        
        .sector-collapse-icon {
            font-size: 14px;
            color: #666;
            transition: transform 0.3s ease;
            width: 20px;
            text-align: center;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .sector-summary {
            font-size: 13px;
            color: #666;
            margin-right: 15px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sector-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        /* ========================================
           移动端组合选择器样式
           ======================================== */
        
        @media (max-width: 768px) {
            .portfolio-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .portfolio-card {
                padding: 10px;
            }
            
            .portfolio-card-name {
                font-size: 13px;
            }
            
            .portfolio-card-value {
                font-size: 16px;
            }
            
            /* 移动端组合选择器 */
            .mobile-portfolio-selector {
                background: linear-gradient(135deg, #1a1f35 0%, #2d1b3d 100%);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }
            
            .mobile-portfolio-header {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 12px;
                color: rgba(255, 255, 255, 0.8);
                font-size: 13px;
            }
            
            .mobile-portfolio-switcher {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .mobile-nav-btn {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: white;
                width: 40px;
                height: 40px;
                border-radius: 8px;
                font-size: 18px;
                cursor: pointer;
                transition: all 0.2s;
                flex-shrink: 0;
            }
            
            .mobile-nav-btn:hover:not(:disabled) {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .mobile-nav-btn:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }
            
            .mobile-portfolio-info {
                flex: 1;
                text-align: center;
                cursor: pointer;
                padding: 10px;
                border-radius: 8px;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-portfolio-name {
                font-size: 18px;
                font-weight: 700;
                color: #e8eaf0;
            }
            
            .mobile-portfolio-stats {
                display: none; /* 隐藏总金额和盈亏百分比 */
            }
            
            .mobile-portfolio-indicators {
                text-align: center;
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
                letter-spacing: 2px;
            }
        }

    </style>
</head>
<body>

<div class="container">

    <!-- 指数面板 -->
    <div class="index-dashboard">
        <div class="index-title">
            <span>📊 全球市场指数</span>
            <button class="index-refresh-btn" onclick="showUserIdManager()" title="管理用户ID">🔑 用户ID</button>
            <button class="index-refresh-btn" onclick="location.reload()">🔄 刷新</button>
        </div>
        <div class="index-grid">
            <div class="index-item" id="index-ndx">
                <div class="index-name">纳斯达克100</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-spx">
                <div class="index-name">标普500</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-csi300">
                <div class="index-name">沪深300</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-redlow">
                <div class="index-name">中证红利低波</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
            <div class="index-item" id="index-gold">
                <div class="index-name">黄金</div>
                <div class="index-value">--</div>
                <div class="index-change">--</div>
            </div>
        </div>
    </div>

    <!-- 组合选择器 -->
    <div id="portfolio-selector-container"></div>

    <div class="daily-pnl-dashboard" id="dailyPnlPanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">
                    💰 持仓看板
                </div>
            </div>
            <div class="pnl-summary">
                <div class="pnl-summary-item">
                    <span class="pnl-label">持仓市值</span>
                    <span class="pnl-value-large" id="totalAssetInPnl">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">累计收益</span>
                    <span class="pnl-value-large" id="totalProfitInPnl">0</span>
                    <span class="pnl-rate" id="totalProfitRateInPnl">0%</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">今日收益</span>
                    <span class="pnl-value" id="totalDailyPnl">0</span>
                    <span class="pnl-rate" id="dailyProfitRate">0%</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">持仓基金数</span>
                    <span class="pnl-count-total" id="totalFundCount">0</span>
                    <span class="pnl-rate" id="profitLossRatio">0/0</span>
                </div>
            </div>
            <div class="pnl-loading" id="pnlLoading">
                <div class="loading-spinner"></div>
                <div>正在获取今日净值数据...</div>
            </div>
        </div>
        
        <div class="pnl-content" id="pnlContent"></div>
    </div>

    <!-- 功能按钮区 -->
    <div class="dashboard-config">
        <div style="flex: 1;">
            <div class="btn-group">
                <button class="btn-dash" id="btnToggleRb" onclick="toggleRebalance()">📊 显示再平衡</button>
                <button class="btn-dash" id="btnToggleCp" onclick="toggleCompound()">🧮 复利推演</button>
                <button class="btn-dash" id="btnToggleEst" onclick="toggleEstimate()">📈 实时预估</button>
                <button class="btn-dash" onclick="syncAllFundNav()">🔄 同步实时净值</button>
                <button class="btn-dash" onclick="saveToCloud()" title="手动保存到云端">☁️ 保存到云端</button>
                <button class="btn-dash" onclick="loadFromCloudManual()" title="手动从云端加载">☁️ 从云端加载</button>
                <button class="btn-dash" onclick="exportData()">⬇️ 备份配置</button>
                <button class="btn-dash" onclick="document.getElementById('importFile').click()">⬆️ 恢复配置</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            <div id="syncStatus" style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.8);"></div>
            <div id="userIdDisplay" style="margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.6);">
                用户ID: <span id="currentUserId" style="font-family: monospace;">--</span>
            </div>
        </div>
    </div>

    <!-- 再平衡分析模块 -->
    <div class="analysis-dashboard" id="rebalancePanel">
        <div class="chart-card">
            <div class="chart-container-inner">
                <canvas id="assetChart"></canvas>
            </div>
            <div style="position:absolute; pointer-events:none; text-align:center;">
                <div style="font-size:12px; color:#999;">持仓分布</div>
                <div style="font-weight:bold; font-size:18px;">实时</div>
            </div>
        </div>

        <div class="rebalance-card">
            <div class="rb-title">⚖️ 智能再平衡建议 (Smart Rebalance)</div>
            <table class="rb-table">
                <thead>
                    <tr>
                        <th>板块</th>
                        <th style="text-align:center">实际%</th>
                        <th style="text-align:center">目标%</th>
                        <th style="text-align:center">状态</th>
                        <th style="text-align:right">建议操作</th>
                    </tr>
                </thead>
                <tbody id="rebalanceBody"></tbody>
            </table>
            <div class="rb-tip">
                💡 <strong>说明：</strong><br>
                • 偏差超过 2% 触发颜色提示。<br>
                • <strong>操作建议</strong>：正数为“需买入金额”(红色)，负数为“需卖出金额”(绿色)。<br>
                • 建议优先通过下方“定投”来动态平衡（买入低配），而不是频繁卖出。
            </div>
        </div>
    </div>

    <div class="compound-dashboard" id="compoundPanel">
        <div class="compound-inputs">
            <div class="cp-title">🔮 复利计算器 (Compound Interest)</div>
            <div class="input-row">
                <label>投入总额 (元)</label>
                <input type="number" id="cpPrincipal" value="1000000" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>预估年化收益率 (%)</label>
                <input type="number" id="cpRate" value="10" onchange="calcCompound()">
            </div>
            <div class="input-row">
                <label>持有年数</label>
                <input type="number" id="cpYears" value="10" onchange="calcCompound()">
            </div>
            <div class="result-box">
                <div class="res-label">A. 一次性投入 N年后总额</div>
                <div class="res-val type-a" id="resLumpSum">¥0</div>
            </div>
            <div class="result-box">
                <div class="res-label">B. 定投 N年后总额 (到达总额)</div>
                <div class="res-val type-b" id="resDCA">¥0</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">(月定投: <span id="cpMonthlyInput">¥0</span>)</div>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-container-inner" style="max-height: 400px;">
                <canvas id="compoundChart"></canvas>
            </div>
        </div>
    </div>

    <div class="daily-pnl-dashboard" id="estimatePanel">
        <div class="pnl-card">
            <div class="pnl-header">
                <div class="pnl-title">📈 实时预估 (Real-time Estimate)</div>
            </div>
            <div class="pnl-summary">
                <div class="pnl-summary-item">
                    <span class="pnl-label">预估总收益</span>
                    <span class="pnl-value" id="totalEstimatePnl">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">盈利基金</span>
                    <span class="pnl-count" id="estimateProfitCount">0</span>
                </div>
                <div class="pnl-summary-item">
                    <span class="pnl-label">亏损基金</span>
                    <span class="pnl-count loss" id="estimateLossCount">0</span>
                </div>
            </div>
            <div class="pnl-loading" id="estimateLoading">
                <div class="loading-spinner"></div>
                <div>正在获取实时估算数据...</div>
            </div>
        </div>
        <div class="pnl-content" id="estimateContent"></div>
    </div>

    <div id="sectors-container"></div>

    <button class="btn-add-sector" onclick="createNewSector()">+ 添加新板块 (Add Sector)</button>

    <div class="strategy-footer">
        <div class="info-card">
            <div class="info-title">🚀 智能加仓策略</div>
            <ul class="strategy-list">
                <li><span class="dot green"></span> <strong>常规回调 (-10% ~ -15%)</strong><br>维持原计划，不动如山。</li>
                <li><span class="dot yellow"></span> <strong>技术熊市 (-20% ~ -25%)</strong><br>启动 <span class="highlight-text">1.5倍 - 2倍</span> 定投。</li>
                <li><span class="dot red"></span> <strong>史诗崩盘 (> -30%)</strong><br>动用备用金，每跌5% <span class="highlight-text">手动买入大额</span>。</li>
            </ul>
        </div>
        <div class="info-card">
            <div class="info-title">📜 定投军规</div>
            <ul class="rules-list">
                <li>1. 只要不失业，绝不停止扣款（底线）。</li>
                <li>2. 建仓期下跌是好事，要“笑着加仓”。</li>
                <li>3. 每年生日检查一次动态平衡，若股票占比>75%则止盈转债。</li>
                <li>4. <strong>美股限购</strong>: 启用多APP（南方/博时/招行）分流。</li>
            </ul>
        </div>
    </div>

</div>

<!-- 用户ID管理弹窗 -->
<div id="userIdModal" class="modal-overlay" onclick="if(event.target === this) closeUserIdManager()">
    <div class="modal-content">
        <div class="modal-title">🔑 用户ID管理</div>
        
        <div class="modal-section">
            <div class="modal-label">当前用户ID</div>
            <div class="modal-value">
                <span id="modalUserId">--</span>
                <button class="copy-btn" onclick="copyUserId()">复制</button>
            </div>
            <div class="modal-hint">
                💡 在其他设备上使用相同的用户ID，即可同步数据
            </div>
        </div>

        <div class="modal-section">
            <div class="modal-label">设置新的用户ID</div>
            <input type="text" id="newUserIdInput" class="modal-input" placeholder="粘贴用户ID...">
            <div class="modal-hint">
                ⚠️ 设置新ID后，将加载该ID对应的数据
            </div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-danger" onclick="resetUserId()">🔄 重置ID</button>
            <button class="modal-btn modal-btn-primary" onclick="setNewUserId()">✅ 设置ID</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeUserIdManager()">取消</button>
        </div>
    </div>
</div>

<!-- 新建组合弹窗 -->
<div id="newPortfolioModal" class="modal-overlay" onclick="if(event.target === this) closeNewPortfolioDialog()">
    <div class="modal-content">
        <div class="modal-title">📁 新建投资组合</div>
        
        <div class="modal-section">
            <div class="modal-label">组合名称</div>
            <input type="text" id="newPortfolioName" class="modal-input" placeholder="例如：稳健组合、激进组合..." value="新组合">
        </div>

        <div class="modal-section">
            <div class="modal-label">组合描述（可选）</div>
            <input type="text" id="newPortfolioDesc" class="modal-input" placeholder="简单描述这个组合的投资策略...">
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="createNewPortfolio()">✅ 创建组合</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeNewPortfolioDialog()">取消</button>
        </div>
    </div>
</div>

<!-- 编辑组合弹窗 -->
<div id="editPortfolioModal" class="modal-overlay" onclick="if(event.target === this) closeEditPortfolioDialog()">
    <div class="modal-content">
        <div class="modal-title">✏️ 编辑组合信息</div>
        
        <div class="modal-section">
            <div class="modal-label">组合名称</div>
            <input type="text" id="editPortfolioName" class="modal-input" placeholder="组合名称">
        </div>

        <div class="modal-section">
            <div class="modal-label">组合描述（可选）</div>
            <input type="text" id="editPortfolioDesc" class="modal-input" placeholder="组合描述">
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="savePortfolioEdit()">✅ 保存修改</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeEditPortfolioDialog()">取消</button>
        </div>
    </div>
</div>

<script>
    // ===== 版本控制 =====
    const APP_VERSION = 'v9.0.0'; // 版本号 - 持仓管理系统
    console.log('📦 应用版本:', APP_VERSION);
    
    // ===== Supabase 云端存储配置 =====
    const SUPABASE_URL = 'https://tweusnlqlgiiuchlfbdr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3ZXVzbmxxbGdpaXVjaGxmYmRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjkxMjksImV4cCI6MjA4NTk0NTEyOX0.3-JvqUMlHigtjwcGHZDdaOhvwq1dDLeoqn2A0gxXNPg';
    
    // 初始化 Supabase 客户端（使用 var 避免重复声明错误）
    var supabase;
    if (typeof window.supabaseClient === 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        window.supabaseClient = supabase;
        console.log('✅ Supabase 客户端初始化成功');
    } else {
        supabase = window.supabaseClient;
        console.log('♻️ 使用已存在的 Supabase 客户端');
    }
    
    // 生成或获取用户ID
    var userId = localStorage.getItem('userId');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        console.log('🆔 生成新用户ID:', userId);
    } else {
        console.log('🆔 使用现有用户ID:', userId);
    }
    
    // ===== 云端存储函数 =====
    
    /**
     * 保存数据到云端
     */
    async function saveToCloud() {
        try {
            showNotification('正在保存到云端...', 'info');
            
            // 检查是否已存在该用户的数据
            const { data: existingData, error: queryError } = await supabase
                .from('fund_data')
                .select('id')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (existingData) {
                // 更新现有数据
                const { error } = await supabase
                    .from('fund_data')
                    .update({
                        data: appData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', userId);
                
                if (error) throw error;
                console.log('✅ 更新云端数据成功');
            } else {
                // 插入新数据
                const { error } = await supabase
                    .from('fund_data')
                    .insert({
                        user_id: userId,
                        data: appData,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
                console.log('✅ 创建云端数据成功');
            }
            
            // 保存成功后，标记已有云端数据
            hasCloudData = true;
            showNotification('数据已保存到云端', 'success');
            return true;
        } catch (error) {
            console.error('❌ 保存到云端失败:', error);
            // 只在控制台记录错误，不显示通知（避免干扰用户）
            // showNotification('保存失败: ' + error.message, 'error');
            return false;
        }
    }
    /**
     * 从云端加载数据
     */
    async function loadFromCloud() {
        try {
            const { data, error } = await supabase
                .from('fund_data')
                .select('data, updated_at')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (error) throw error;
            
            if (data) {
                console.log('✅ 从云端加载数据成功');
                console.log('📅 最后更新时间:', new Date(data.updated_at).toLocaleString('zh-CN'));
                return data.data;
            }
            
            console.log('⚠️ 云端没有数据');
            return null;
        } catch (error) {
            console.error('❌ 从云端加载失败:', error);
            // 只在控制台记录错误，不显示通知（避免干扰用户）
            // showNotification('加载失败: ' + error.message, 'error');
            return null;
        }
    }
    
    /**
     * 手动从云端加载
     */
    async function loadFromCloudManual() {
        showNotification('正在从云端加载...', 'info');
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            appData = migrateToV9(cloudData);  // 添加 V9 迁移
            hasCloudData = true; // 标记已从云端加载数据
            renderApp();
            calcAll();
            showNotification('数据已从云端加载', 'success');
        } else {
            showNotification('云端没有数据', 'warning');
        }
    }
    
    /**
     * 显示通知
     */
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const colors = {
            success: '#52c41a',
            error: '#ff4d4f',
            info: '#1890ff',
            warning: '#faad14'
        };
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${colors[type]};
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    // 添加CSS动画
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    // --- 默认数据模版 (V9格式 - 持仓管理系统) ---
    const DEFAULT_DATA = {
        currentPortfolioId: 'portfolio_default',
        portfolios: [
            {
                id: 'portfolio_default',
                name: '默认组合',
                description: '我的第一个投资组合',
                color: '#1890ff',
                createdAt: new Date().toISOString(),
                sectors: [
                    {
                        id: 'sec_1', name: 'US 美股 (进攻主力)', color: '#dc2626', weight: 35,
                        funds: [{ name: '摩根标普500(A)', code: '019303', share: 0, cost: 0, nav: 1.0 }]
                    },
                    {
                        id: 'sec_2', name: 'CN A股 (成长复苏)', color: '#db2777', weight: 20,
                        funds: [{ name: '兴全合润', code: '163406', share: 0, cost: 0, nav: 1.0 }]
                    },
                    {
                        id: 'sec_3', name: '红利低波', color: '#059669', weight: 15,
                        funds: [{ name: '南方红利低波', code: '008163', share: 0, cost: 0, nav: 1.0 }]
                    },
                    {
                        id: 'sec_4', name: '黄金避险', color: '#d97706', weight: 15,
                        funds: [{ name: '工银黄金ETF', code: '008142', share: 0, cost: 0, nav: 1.0 }]
                    },
                    {
                        id: 'sec_5', name: '债基底仓', color: '#1890ff', weight: 15,
                        funds: [{ name: '招商产业债A', code: '217022', share: 0, cost: 0, nav: 1.0 }]
                    }
                ]
            }
        ]
    };

    let appData = null;
    let myChart = null; // 再平衡图表
    let compoundChart = null; // 复利图表
    let hasCloudData = false; // 标记是否从云端加载过数据

    // ===== UI状态管理器（折叠功能）=====
    const UIState = {
        collapsedPortfolios: new Set(),
        collapsedSectors: new Set(),
        collapsedPnlSectors: new Set(),  // 持仓看板板块折叠状态
        rebalanceCollapsed: true,       // 再平衡模块默认折叠
        
        load() {
            try {
                const saved = localStorage.getItem('smartSIP_ui_state');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.collapsedPortfolios = new Set(data.collapsedPortfolios || []);
                    this.collapsedSectors = new Set(data.collapsedSectors || []);
                    this.collapsedPnlSectors = new Set(data.collapsedPnlSectors || []);
                    this.rebalanceCollapsed = data.rebalanceCollapsed !== undefined ? data.rebalanceCollapsed : true;
                    console.log('✅ UI状态加载成功');
                }
            } catch (e) {
                console.error('❌ 加载UI状态失败:', e);
            }
        },
        
        save() {
            try {
                const data = {
                    collapsedPortfolios: Array.from(this.collapsedPortfolios),
                    collapsedSectors: Array.from(this.collapsedSectors),
                    collapsedPnlSectors: Array.from(this.collapsedPnlSectors),
                    rebalanceCollapsed: this.rebalanceCollapsed
                };
                localStorage.setItem('smartSIP_ui_state', JSON.stringify(data));
            } catch (e) {
                console.error('❌ 保存UI状态失败:', e);
            }
        },
        
        isPortfolioCollapsed(portfolioId) {
            return this.collapsedPortfolios.has(portfolioId);
        },
        
        isSectorCollapsed(sectorId) {
            return this.collapsedSectors.has(sectorId);
        },
        
        togglePortfolio(portfolioId) {
            if (this.collapsedPortfolios.has(portfolioId)) {
                this.collapsedPortfolios.delete(portfolioId);
                return false;
            } else {
                this.collapsedPortfolios.add(portfolioId);
                return true;
            }
        },
        
        toggleSector(sectorId) {
            if (this.collapsedSectors.has(sectorId)) {
                this.collapsedSectors.delete(sectorId);
                return false;
            } else {
                this.collapsedSectors.add(sectorId);
                return true;
            }
        }
    };

    // ===== 数据迁移函数 =====
    function migrateToV8() {
        const v7Data = localStorage.getItem('smartSIP_data_v7');
        if (!v7Data) {
            console.log('📦 没有V7数据，使用默认数据');
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        
        try {
            const oldData = JSON.parse(v7Data);
            
            if (oldData.portfolios) {
                console.log('✅ 数据已经是V8格式');
                return oldData;
            }
            
            console.log('🔄 开始迁移V7数据到V8...');
            const newData = {
                currentPortfolioId: 'portfolio_default',
                portfolios: [
                    {
                        id: 'portfolio_default',
                        name: '默认组合',
                        description: '从旧版本迁移的数据',
                        totalGoal: oldData.totalGoal || 1000000,
                        months: oldData.months || 24,
                        color: '#1890ff',
                        createdAt: new Date().toISOString(),
                        sectors: oldData.sectors || []
                    }
                ]
            };
            
            localStorage.setItem('smartSIP_data_v7_backup', v7Data);
            console.log('💾 V7数据已备份');
            
            localStorage.setItem('smartSIP_data_v8', JSON.stringify(newData));
            console.log('✅ 数据迁移完成');
            
            return newData;
            
        } catch (e) {
            console.error('❌ 数据迁移失败:', e);
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
    }

    // ===== V9数据迁移函数 =====
    function migrateToV9(data) {
        if (!data || !data.portfolios) {
            console.log('📦 没有旧数据，使用默认数据');
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        
        console.log('🔄 开始迁移到V9格式（持仓管理系统）...');
        
        // 清理每个组合的数据
        data.portfolios.forEach(portfolio => {
            // 移除组合级别的定投字段
            delete portfolio.totalGoal;
            delete portfolio.months;
            
            // 清理每个板块的数据
            if (portfolio.sectors) {
                portfolio.sectors.forEach(sector => {
                    // 移除板块的定投策略字段
                    delete sector.strategy;
                    
                    // 清理每个基金的数据
                    if (sector.funds) {
                        sector.funds.forEach(fund => {
                            // 移除基金的板块内占比字段
                            delete fund.percent;
                        });
                    }
                });
            }
        });
        
        console.log('✅ 数据迁移到V9完成');
        return data;
    }

    // ===== 组合管理函数 =====
    function getCurrentPortfolio() {
        if (!appData.portfolios || appData.portfolios.length === 0) {
            console.error('❌ 没有可用的组合');
            return null;
        }
        
        let portfolio = appData.portfolios.find(p => p.id === appData.currentPortfolioId);
        
        if (!portfolio) {
            console.warn('⚠️ 当前组合ID无效，使用第一个组合');
            portfolio = appData.portfolios[0];
            appData.currentPortfolioId = portfolio.id;
        }
        
        return portfolio;
    }

    function switchPortfolio(portfolioId) {
        if (appData.currentPortfolioId === portfolioId) {
            return;
        }
        
        const portfolio = appData.portfolios.find(p => p.id === portfolioId);
        if (!portfolio) {
            console.error('组合不存在:', portfolioId);
            return;
        }
        
        showNotification(`切换到: ${portfolio.name}`, 'info');
        
        appData.currentPortfolioId = portfolioId;
        
        renderApp();
        loadDailyPnL();
        
        saveToLocal();
        saveToCloud();
    }

    function isMobileDevice() {
        return window.innerWidth <= 768;
    }

    // --- 初始化 ---
    window.onload = async function() {
        showNotification('正在加载数据...', 'info');
        updateUserIdDisplay();
        
        // 初始化UI状态
        UIState.load();
        
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            // 迁移云端数据到V9
            appData = migrateToV9(cloudData);
            hasCloudData = true; // 标记已从云端加载数据
            console.log('📥 使用云端数据（已迁移到V9）');
            await saveToCloud(); // 保存迁移后的数据
        } else {
            // 云端没有数据，标记为未加载
            hasCloudData = false;
            console.log('⚠️ 云端没有数据，使用本地数据');
            
            // 检查本地V9数据
            const v9Local = localStorage.getItem('smartSIP_data_v9');
            if (v9Local) {
                try {
                    appData = JSON.parse(v9Local);
                    console.log('📥 使用本地V9数据');
                } catch (e) {
                    console.error('本地V9数据解析失败:', e);
                    // 尝试从V8迁移
                    const v8Data = migrateToV8();
                    appData = migrateToV9(v8Data);
                }
            } else {
                // 检查本地V8数据
                const v8Local = localStorage.getItem('smartSIP_data_v8');
                if (v8Local) {
                    try {
                        const v8Data = JSON.parse(v8Local);
                        appData = migrateToV9(v8Data);
                        console.log('📥 从本地V8数据迁移到V9');
                        // 备份V8数据
                        localStorage.setItem('smartSIP_data_v8_backup', v8Local);
                    } catch (e) {
                        console.error('本地V8数据解析失败:', e);
                        const v8Data = migrateToV8();
                        appData = migrateToV9(v8Data);
                    }
                } else {
                    // 从V7迁移
                    const v8Data = migrateToV8();
                    appData = migrateToV9(v8Data);
                }
            }
        }
        
        if (!appData.portfolios || appData.portfolios.length === 0) {
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        
        initChart();
        renderApp();
        loadIndexData();
        loadDailyPnL();
    };

    // --- 用户ID管理功能 ---
    
    /**
     * 更新页面上显示的用户ID
     */
    function updateUserIdDisplay() {
        const displayEl = document.getElementById('currentUserId');
        if (displayEl) {
            displayEl.textContent = userId;
        }
    }
    
    /**
     * 显示用户ID管理弹窗
     */
    function showUserIdManager() {
        const modal = document.getElementById('userIdModal');
        const modalUserId = document.getElementById('modalUserId');
        const newUserIdInput = document.getElementById('newUserIdInput');
        
        modalUserId.textContent = userId;
        newUserIdInput.value = '';
        modal.style.display = 'flex';
    }
    
    /**
     * 关闭用户ID管理弹窗
     */
    function closeUserIdManager() {
        const modal = document.getElementById('userIdModal');
        modal.style.display = 'none';
    }
    
    /**
     * 复制用户ID到剪贴板
     */
    function copyUserId() {
        const textToCopy = userId;
        
        // 尝试使用现代API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('用户ID已复制到剪贴板', 'success');
            }).catch(err => {
                // 降级方案
                fallbackCopy(textToCopy);
            });
        } else {
            // 降级方案
            fallbackCopy(textToCopy);
        }
    }
    
    /**
     * 降级复制方案（兼容旧浏览器）
     */
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            showNotification('用户ID已复制到剪贴板', 'success');
        } catch (err) {
            showNotification('复制失败，请手动复制', 'error');
        }
        
        document.body.removeChild(textArea);
    }
    
    /**
     * 设置新的用户ID
     */
    async function setNewUserId() {
        const newUserIdInput = document.getElementById('newUserIdInput');
        const newUserId = newUserIdInput.value.trim();
        
        if (!newUserId) {
            showNotification('请输入用户ID', 'warning');
            return;
        }
        
        if (newUserId === userId) {
            showNotification('新ID与当前ID相同', 'warning');
            return;
        }
        
        if (!confirm(`确定要切换到新的用户ID吗？\n\n新ID: ${newUserId}\n\n切换后将加载该ID对应的数据。`)) {
            return;
        }
        
        // 保存新的用户ID
        userId = newUserId;
        localStorage.setItem('userId', userId);
        
        // 更新显示
        updateUserIdDisplay();
        
        // 关闭弹窗
        closeUserIdManager();
        
        // 显示提示
        showNotification('用户ID已更新，正在加载数据...', 'info');
        
        // 重新加载数据
        const cloudData = await loadFromCloud();
        
        if (cloudData) {
            appData = migrateToV9(cloudData);  // 添加 V9 迁移
            hasCloudData = true; // 标记已从云端加载数据
            renderApp();
            calcAll();
            showNotification('数据已从云端加载', 'success');
        } else {
            showNotification('云端没有该ID的数据，将使用默认数据', 'warning');
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            renderApp();
            calcAll();
        }
    }
    
    /**
     * 重置用户ID（生成新ID）
     */
    function resetUserId() {
        if (!confirm('确定要重置用户ID吗？\n\n重置后将生成新的ID，当前数据将保留在云端，但需要使用旧ID才能访问。\n\n建议先备份配置！')) {
            return;
        }
        
        // 生成新ID
        const newUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        userId = newUserId;
        localStorage.setItem('userId', userId);
        
        // 更新显示
        updateUserIdDisplay();
        document.getElementById('modalUserId').textContent = userId;
        
        // 显示提示
        showNotification('用户ID已重置: ' + userId, 'success');
        
        console.log('🆔 新用户ID:', userId);
    }

    // ===== 组合选择器渲染 =====
    function renderPortfolioSelector() {
        const isMobile = isMobileDevice();
        
        if (isMobile) {
            renderMobilePortfolioSelector();
        } else {
            renderDesktopPortfolioSelector();
        }
    }

    function renderDesktopPortfolioSelector() {
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        let html = `
            <div class="portfolio-selector">
                <div class="portfolio-header">
                    <div class="portfolio-title">📁 我的投资组合</div>
                    <button class="btn-new-portfolio" onclick="showNewPortfolioDialog()">+ 新建组合</button>
                </div>
                <div class="portfolio-cards">
        `;
        
        appData.portfolios.forEach(p => {
            const isActive = p.id === appData.currentPortfolioId;
            
            let totalAsset = 0;
            let totalCost = 0;
            p.sectors.forEach(sector => {
                sector.funds.forEach(fund => {
                    totalAsset += fund.share * fund.nav;
                    totalCost += fund.share * fund.cost;
                });
            });
            const profitRate = totalCost > 0 ? ((totalAsset - totalCost) / totalCost * 100) : 0;
            
            html += `
                <div class="portfolio-card ${isActive ? 'active' : ''}" 
                     onclick="switchPortfolio('${p.id}')">
                    <div class="portfolio-card-header">
                        <div class="portfolio-card-name">${p.name}</div>
                        <button class="portfolio-card-menu" onclick="showEditPortfolioDialog('${p.id}'); event.stopPropagation();" title="编辑组合">⋮</button>
                    </div>
                    <div class="portfolio-card-value">
                        ¥${Math.round(totalAsset).toLocaleString()}
                    </div>
                    <div class="portfolio-card-profit" style="color: ${profitRate >= 0 ? '#ff5757' : '#51cf66'}">
                        ${profitRate >= 0 ? '+' : ''}${profitRate.toFixed(2)}%
                    </div>
                    ${isActive ? '<div class="portfolio-card-badge">当前</div>' : ''}
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        const container = document.getElementById('portfolio-selector-container');
        if (container) {
            container.innerHTML = html;
        }
    }

    function renderMobilePortfolioSelector() {
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        const currentIndex = appData.portfolios.findIndex(p => p.id === portfolio.id);
        const totalCount = appData.portfolios.length;
        
        let totalAsset = 0;
        let totalCost = 0;
        portfolio.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                totalAsset += fund.share * fund.nav;
                totalCost += fund.share * fund.cost;
            });
        });
        const profitRate = totalCost > 0 ? ((totalAsset - totalCost) / totalCost * 100) : 0;
        
        let indicators = '';
        for (let i = 0; i < totalCount; i++) {
            indicators += i === currentIndex ? '●' : '○';
        }
        
        const html = `
            <div class="mobile-portfolio-selector">
                <div class="mobile-portfolio-header">
                    <span class="mobile-portfolio-icon">📁</span>
                    <span class="mobile-portfolio-label">我的投资组合</span>
                    <button class="index-refresh-btn" onclick="showEditPortfolioDialog('${portfolio.id}')" title="编辑组合">✏️</button>
                    <button class="index-refresh-btn" onclick="showNewPortfolioDialog()">+ 新建</button>
                </div>
                <div class="mobile-portfolio-switcher">
                    <button class="mobile-nav-btn" onclick="switchToPrevPortfolio()" 
                            ${currentIndex === 0 ? 'disabled' : ''}>
                        ←
                    </button>
                    <div class="mobile-portfolio-info">
                        <div class="mobile-portfolio-name">${portfolio.name}</div>
                        <div class="mobile-portfolio-stats">
                            <span class="mobile-portfolio-value">¥${Math.round(totalAsset).toLocaleString()}</span>
                            <span class="mobile-portfolio-profit" style="color: ${profitRate >= 0 ? '#ff5757' : '#51cf66'}">
                                ${profitRate >= 0 ? '+' : ''}${profitRate.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                    <button class="mobile-nav-btn" onclick="switchToNextPortfolio()"
                            ${currentIndex === totalCount - 1 ? 'disabled' : ''}>
                        →
                    </button>
                </div>
                <div class="mobile-portfolio-indicators">
                    ${indicators} (${currentIndex + 1}/${totalCount})
                </div>
            </div>
        `;
        
        const container = document.getElementById('portfolio-selector-container');
        if (container) {
            container.innerHTML = html;
        }
    }

    function switchToPrevPortfolio() {
        const currentIndex = appData.portfolios.findIndex(p => p.id === appData.currentPortfolioId);
        if (currentIndex > 0) {
            switchPortfolio(appData.portfolios[currentIndex - 1].id);
        }
    }

    function switchToNextPortfolio() {
        const currentIndex = appData.portfolios.findIndex(p => p.id === appData.currentPortfolioId);
        if (currentIndex < appData.portfolios.length - 1) {
            switchPortfolio(appData.portfolios[currentIndex + 1].id);
        }
    }

    // ===== 折叠功能 =====
    function toggleSectorCollapse(sectorId, event) {
        if (event) {
            event.stopPropagation();
        }
        
        const contentEl = document.getElementById(`sector-content-${sectorId}`);
        const iconEl = document.getElementById(`sector-icon-${sectorId}`);
        const btnEl = document.querySelector(`#${sectorId} .btn-add-fund`);
        
        if (!contentEl || !iconEl) return;
        
        const isCollapsed = UIState.toggleSector(sectorId);
        UIState.save();
        
        if (isCollapsed) {
            contentEl.style.display = 'none';
            if (btnEl) btnEl.style.display = 'none';
            iconEl.textContent = '▶';
        } else {
            contentEl.style.display = 'block';
            if (btnEl) btnEl.style.display = 'block';
            iconEl.textContent = '▼';
        }
    }

    // 持仓看板板块折叠功能
    function togglePnlSector(sectorId, event) {
        if (event) {
            event.stopPropagation();
        }
        
        const contentEl = document.getElementById(`pnl-content-${sectorId}`);
        const iconEl = document.getElementById(`pnl-icon-${sectorId}`);
        
        if (!contentEl || !iconEl) return;
        
        // 使用独立的状态管理
        if (!UIState.collapsedPnlSectors) {
            UIState.collapsedPnlSectors = new Set();
        }
        
        const isCollapsed = UIState.collapsedPnlSectors.has(sectorId);
        
        if (isCollapsed) {
            UIState.collapsedPnlSectors.delete(sectorId);
            contentEl.style.display = 'block';
            iconEl.textContent = '▼';
        } else {
            UIState.collapsedPnlSectors.add(sectorId);
            contentEl.style.display = 'none';
            iconEl.textContent = '▶';
        }
        
        UIState.save();
    }

    // ===== 新建组合功能 =====
    function showNewPortfolioDialog() {
        const modal = document.getElementById('newPortfolioModal');
        document.getElementById('newPortfolioName').value = '新组合';
        document.getElementById('newPortfolioDesc').value = '';
        modal.style.display = 'flex';
    }

    function closeNewPortfolioDialog() {
        const modal = document.getElementById('newPortfolioModal');
        modal.style.display = 'none';
    }

    function createNewPortfolio() {
        const name = document.getElementById('newPortfolioName').value.trim();
        const description = document.getElementById('newPortfolioDesc').value.trim();

        if (!name) {
            showNotification('请输入组合名称', 'warning');
            return;
        }

        const newPortfolio = {
            id: 'portfolio_' + Date.now(),
            name: name,
            description: description || '新建的投资组合',
            totalGoal: 1000000,  // 默认值
            months: 24,          // 默认值
            color: '#1890ff',
            createdAt: new Date().toISOString(),
            sectors: [
                {
                    id: 'sec_' + Date.now(),
                    name: '示例板块',
                    color: '#1890ff',
                    weight: 100,
                    strategy: 'sip',
                    funds: [
                        {
                            name: '示例基金',
                            code: '',
                            share: 0,
                            cost: 0,
                            nav: 1.0,
                            percent: 100
                        }
                    ]
                }
            ]
        };

        appData.portfolios.push(newPortfolio);
        appData.currentPortfolioId = newPortfolio.id;

        closeNewPortfolioDialog();
        showNotification(`组合"${name}"创建成功`, 'success');

        renderApp();
        saveToLocal();
        saveToCloud();
    }

    // ===== 编辑组合功能 =====
    let editingPortfolioId = null;

    function showEditPortfolioDialog(portfolioId) {
        const portfolio = appData.portfolios.find(p => p.id === portfolioId);
        if (!portfolio) return;

        editingPortfolioId = portfolioId;
        const modal = document.getElementById('editPortfolioModal');
        document.getElementById('editPortfolioName').value = portfolio.name;
        document.getElementById('editPortfolioDesc').value = portfolio.description || '';
        modal.style.display = 'flex';
    }

    function closeEditPortfolioDialog() {
        const modal = document.getElementById('editPortfolioModal');
        modal.style.display = 'none';
        editingPortfolioId = null;
    }

    function savePortfolioEdit() {
        if (!editingPortfolioId) return;

        const portfolio = appData.portfolios.find(p => p.id === editingPortfolioId);
        if (!portfolio) return;

        const name = document.getElementById('editPortfolioName').value.trim();
        const description = document.getElementById('editPortfolioDesc').value.trim();

        if (!name) {
            showNotification('请输入组合名称', 'warning');
            return;
        }

        portfolio.name = name;
        portfolio.description = description;

        closeEditPortfolioDialog();
        showNotification('组合信息已更新', 'success');

        renderApp();
        saveToLocal();
        saveToCloud();
    }

    // --- 加载指数数据 ---
    function loadIndexData() {
        const indices = [
            { id: 'index-ndx', code: '100.NDX', name: '纳斯达克100' },
            { id: 'index-spx', code: '100.SPX', name: '标普500' },
            { id: 'index-csi300', code: '1.000300', name: '沪深300' },
            { id: 'index-redlow', code: '1.515100', name: '中证红利低波' },
            { id: 'index-gold', code: '1.518660', name: '黄金' }
        ];

        indices.forEach((index, i) => {
            setTimeout(() => {
                fetchIndexData(index.id, index.code, index.name);
            }, i * 300); // 串行请求，间隔300ms
        });
    }

    // 获取单个指数数据
    function fetchIndexData(elementId, code, name) {
        // 使用K线接口获取最新数据
        const script = document.createElement('script');
        const callbackName = 'indexCallback_' + elementId.replace(/-/g, '_') + '_' + Date.now();
        
        const timeout = setTimeout(() => {
            cleanup();
            console.error(`获取${name}数据超时`);
            updateIndexDisplay(elementId, '--', 0, true);
        }, 10000);

        function cleanup() {
            delete window[callbackName];
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
        }

        window[callbackName] = function(result) {
            clearTimeout(timeout);
            cleanup();
            
            try {
                if (result.rc === 0 && result.data && result.data.klines && result.data.klines.length > 0) {
                    const klines = result.data.klines;
                    
                    // 获取最新一天的数据
                    const latestKline = klines[klines.length - 1];
                    const parts = latestKline.split(',');
                    
                    if (parts.length >= 3) {
                        const latest = parseFloat(parts[2]); // 最新收盘价
                        
                        // 获取昨日收盘价
                        let yesterday = parseFloat(parts[1]); // 今日开盘价（通常等于昨日收盘）
                        
                        // 如果有前一天的数据，使用前一天的收盘价更准确
                        if (klines.length >= 2) {
                            const prevKline = klines[klines.length - 2];
                            const prevParts = prevKline.split(',');
                            if (prevParts.length >= 3) {
                                yesterday = parseFloat(prevParts[2]);
                            }
                        }
                        
                        const change = latest - yesterday;
                        const changePercent = yesterday > 0 ? (change / yesterday * 100) : 0;

                        updateIndexDisplay(elementId, latest, changePercent);
                    } else {
                        updateIndexDisplay(elementId, '--', 0, true);
                    }
                } else {
                    updateIndexDisplay(elementId, '--', 0, true);
                }
            } catch (e) {
                console.error(`解析${name}数据失败:`, e);
                updateIndexDisplay(elementId, '--', 0, true);
            }
        };

        script.onerror = () => {
            clearTimeout(timeout);
            cleanup();
            console.error(`加载${name}数据失败`);
            updateIndexDisplay(elementId, '--', 0, true);
        };

        // 使用K线接口，获取最近2天数据
        script.src = `https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${code}&fields1=f1,f2,f3&fields2=f51,f52,f53&klt=101&fqt=0&end=20500101&lmt=2&cb=${callbackName}`;
        document.head.appendChild(script);
    }

    // 更新指数显示
    function updateIndexDisplay(elementId, value, changePercent, isError = false) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const valueEl = element.querySelector('.index-value');
        const changeEl = element.querySelector('.index-change');

        if (isError) {
            valueEl.textContent = '--';
            changeEl.textContent = '数据获取失败';
            changeEl.className = 'index-change zero';
            return;
        }

        // 更新数值
        if (typeof value === 'number') {
            valueEl.textContent = value.toFixed(2);
        } else {
            valueEl.textContent = value;
        }

        // 更新涨跌幅
        if (changePercent > 0) {
            changeEl.textContent = `+${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change positive';
        } else if (changePercent < 0) {
            changeEl.textContent = `${changePercent.toFixed(2)}%`;
            changeEl.className = 'index-change negative';
        } else {
            changeEl.textContent = '0.00%';
            changeEl.className = 'index-change zero';
        }
    }

    // --- 功能开关 ---
    function toggleRebalance() {
        const panel = document.getElementById('rebalancePanel');
        const btn = document.getElementById('btnToggleRb');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? '🫣 隐藏再平衡' : '📊 显示再平衡';
        btn.classList.toggle('btn-toggle-active');
        if(isHidden && myChart) myChart.resize(); 
    }

    function toggleCompound() {
        const panel = document.getElementById('compoundPanel');
        const btn = document.getElementById('btnToggleCp');
        const isHidden = panel.style.display !== 'grid';
        
        panel.style.display = isHidden ? 'grid' : 'none';
        btn.innerText = isHidden ? '🫣 隐藏推演' : '🧮 复利推演';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // 首次展开时，自动填入当前总投入目标作为本金
            if(document.getElementById('cpPrincipal').value == "1000000") {
                document.getElementById('cpPrincipal').value = document.getElementById('totalGoal').value;
            }
            calcCompound(); // 计算并绘图
        }
    }

    function toggleEstimate() {
        const panel = document.getElementById('estimatePanel');
        const btn = document.getElementById('btnToggleEst');
        const isHidden = panel.style.display !== 'block';
        
        panel.style.display = isHidden ? 'block' : 'none';
        btn.innerText = isHidden ? '🫣 隐藏预估' : '📈 实时预估';
        btn.classList.toggle('btn-toggle-active');
        
        if(isHidden) {
            // 首次展开时，自动获取实时预估
            loadEstimate();
        }
    }

    // 加载今日盈亏数据
    function loadDailyPnL() {
        const loadingEl = document.getElementById('pnlLoading');
        const contentEl = document.getElementById('pnlContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // ✅ 修改：从当前组合收集基金
        const portfolio = getCurrentPortfolio();
        if (!portfolio) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">暂无组合数据</div>';
            return;
        }
        
        // 收集所有基金
        portfolio.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">暂无持仓基金</div>';
            return;
        }
        
        // 串行获取每只基金的今日数据
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // 全部完成，渲染结果
                loadingEl.style.display = 'none';
                renderDailyPnL(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchDailyNavData(fund.code)
                .then(data => {
                    if (data.success) {
                        // 计算今日收益
                        const todayNav = data.nav;
                        const yesterdayNav = data.yesterdayNav || todayNav;
                        const growthRate = yesterdayNav > 0 ? ((todayNav - yesterdayNav) / yesterdayNav * 100) : 0;
                        const dailyProfit = fund.share * (todayNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: todayNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            navDate: data.date
                        });
                    }
                })
                .catch(err => {
                    console.error(`获取 ${fund.code} 失败:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // 获取基金今日和昨日净值
    function fetchDailyNavData(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                setTimeout(() => {
                    try {
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length >= 1) {
                                // 今日净值
                                const todayCells = rows[0].querySelectorAll('td');
                                const todayNav = parseFloat(todayCells[1].textContent.trim()) || 0;
                                const todayDate = todayCells[0].textContent.trim();
                                
                                // 昨日净值
                                let yesterdayNav = todayNav;
                                if (rows.length >= 2) {
                                    const yesterdayCells = rows[1].querySelectorAll('td');
                                    yesterdayNav = parseFloat(yesterdayCells[1].textContent.trim()) || todayNav;
                                }
                                
                                clearTimeout(timeout);
                                cleanup();
                                resolve({
                                    success: true,
                                    code: code,
                                    nav: todayNav,
                                    yesterdayNav: yesterdayNav,
                                    date: todayDate
                                });
                                return;
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=2&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // 渲染今日盈亏
    function renderDailyPnL(results) {
        const contentEl = document.getElementById('pnlContent');
        
        // 按板块分组
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // 计算总收益、持仓市值和浮盈
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        let totalAsset = 0;
        let totalCost = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
            
            // 计算持仓市值和成本
            const marketValue = item.share * item.todayNav;
            const costValue = item.share * item.costNav;
            totalAsset += marketValue;
            totalCost += costValue;
        });
        
        const totalFloatProfit = totalAsset - totalCost;
        const totalFloatProfitRate = totalCost > 0 ? (totalFloatProfit / totalCost * 100) : 0;
        
        // 更新顶部汇总 - 今日收益
        const totalPnlEl = document.getElementById('totalDailyPnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        
        // 计算今日收益率
        const dailyProfitRate = totalAsset > 0 ? (totalProfit / totalAsset * 100) : 0;
        const dailyProfitRateEl = document.getElementById('dailyProfitRate');
        dailyProfitRateEl.textContent = (dailyProfitRate >= 0 ? '+' : '') + dailyProfitRate.toFixed(2) + '%';
        dailyProfitRateEl.style.color = dailyProfitRate >= 0 ? '#ff4d4f' : '#52c41a';
        
        // 更新持仓基金数和盈亏比例（带颜色）
        document.getElementById('totalFundCount').textContent = results.length;
        const profitLossRatioEl = document.getElementById('profitLossRatio');
        profitLossRatioEl.innerHTML = `<span style="color: #ff4d4f">${profitCount}</span>/<span style="color: #52c41a">${lossCount}</span>`;
        
        // 更新持仓市值
        const totalAssetEl = document.getElementById('totalAssetInPnl');
        totalAssetEl.textContent = Math.round(totalAsset).toLocaleString();
        
        // 更新累计浮盈
        const totalProfitEl = document.getElementById('totalProfitInPnl');
        totalProfitEl.textContent = (totalFloatProfit >= 0 ? '+' : '') + Math.round(totalFloatProfit).toLocaleString();
        totalProfitEl.style.color = totalFloatProfit >= 0 ? '#ff4d4f' : '#52c41a';
        
        const totalProfitRateEl = document.getElementById('totalProfitRateInPnl');
        totalProfitRateEl.textContent = (totalFloatProfitRate >= 0 ? '+' : '') + totalFloatProfitRate.toFixed(2) + '%';
        totalProfitRateEl.style.color = totalFloatProfitRate >= 0 ? '#ff4d4f' : '#52c41a';
        
        // 渲染各板块
        let html = '';
        const isMobile = window.innerWidth <= 768;
        
        // ✅ 修改：使用当前组合的板块
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        portfolio.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // 计算板块总收益、持仓总额和收益率
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            let sectorTotalAsset = 0;
            let sectorTotalCost = 0;
            
            sectorData.funds.forEach(fund => {
                const marketValue = fund.share * fund.todayNav;
                const costValue = fund.share * fund.costNav;
                sectorTotalAsset += marketValue;
                sectorTotalCost += costValue;
            });
            
            const sectorHoldingProfit = sectorTotalAsset - sectorTotalCost;
            const sectorHoldingProfitRate = sectorTotalCost > 0 ? (sectorHoldingProfit / sectorTotalCost * 100) : 0;
            
            html += `
                <div class="pnl-sector" id="pnl-sector-${sector.id}" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header" onclick="togglePnlSector('${sector.id}', event)" style="cursor: pointer;">
                        <div class="pnl-sector-name">
                            <span class="sector-collapse-icon" id="pnl-icon-${sector.id}">▼</span>
                            <span style="color:${sectorData.color}; font-size:20px;">●</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-stats">
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                                </div>
                            </div>
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-asset">${Math.round(sectorTotalAsset).toLocaleString()}</div>
                                <div class="pnl-sector-rate" style="color: ${sectorHoldingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorHoldingProfitRate >= 0 ? '+' : ''}${sectorHoldingProfitRate.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pnl-sector-content" id="pnl-content-${sector.id}">
            `;
            
            if (isMobile) {
                // 手机端：使用新的卡片式布局
                html += `<div class="pnl-mobile-list">`;
                
                sectorData.funds.forEach(fund => {
                    const totalMarketValue = fund.share * fund.todayNav;
                    const holdingProfit = totalMarketValue - (fund.share * fund.costNav);
                    const holdingProfitRate = (holdingProfit / (fund.share * fund.costNav)) * 100;
                    
                    html += `
                        <div class="pnl-mobile-item">
                            <div class="pnl-mobile-header">
                                <div class="pnl-mobile-fund-info">
                                    <div class="pnl-mobile-fund-name">${fund.name}</div>
                                    <div class="pnl-mobile-fund-code">${fund.code}</div>
                                </div>
                            </div>
                            <div class="pnl-mobile-data">
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">日收益</div>
                                    <div class="pnl-mobile-value" style="color: ${fund.dailyProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${fund.growthRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">持仓收益</div>
                                    <div class="pnl-mobile-value" style="color: ${holdingProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfit >= 0 ? '+' : ''}${holdingProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${holdingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfitRate >= 0 ? '+' : ''}${holdingProfitRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">总市值</div>
                                    <div class="pnl-mobile-value">${totalMarketValue.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`; // 关闭 pnl-mobile-list 和 pnl-sector-content
            } else {
                // PC端：保持原有表格布局
                html += `
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>基金代码</th>
                                <th>基金名称</th>
                                <th>单位净值</th>
                                <th>日涨幅</th>
                                <th>持仓份额</th>
                                <th>今日收益</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sectorData.funds.forEach(fund => {
                    const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                    const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                    
                    html += `
                        <tr>
                            <td><span class="fund-code">${fund.code}</span></td>
                            <td><span class="fund-name">${fund.name}</span></td>
                            <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                            <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                            <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                            <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `</div></div>`; // 关闭 pnl-sector-content 和 pnl-sector
        });
        
        contentEl.innerHTML = html;
        
        // 初始化板块折叠状态
        if (UIState.collapsedPnlSectors) {
            UIState.collapsedPnlSectors.forEach(sectorId => {
                const contentEl = document.getElementById(`pnl-content-${sectorId}`);
                const iconEl = document.getElementById(`pnl-icon-${sectorId}`);
                if (contentEl && iconEl) {
                    contentEl.style.display = 'none';
                    iconEl.textContent = '▶';
                }
            });
        }
    }

    // 加载实时预估数据（使用天天基金接口）
    function loadEstimate() {
        const loadingEl = document.getElementById('estimateLoading');
        const contentEl = document.getElementById('estimateContent');
        
        loadingEl.style.display = 'block';
        contentEl.innerHTML = '';
        
        const fundList = [];
        
        // ✅ 修改：从当前组合收集基金
        const portfolio = getCurrentPortfolio();
        if (!portfolio) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">暂无组合数据</div>';
            return;
        }
        
        // 收集所有基金
        portfolio.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '' && fund.share > 0) {
                    fundList.push({
                        sectorId: sector.id,
                        sectorName: sector.name,
                        sectorColor: sector.color,
                        code: fund.code,
                        name: fund.name,
                        share: fund.share,
                        costNav: fund.cost
                    });
                }
            });
        });
        
        if (fundList.length === 0) {
            loadingEl.style.display = 'none';
            contentEl.innerHTML = '<div style="padding:60px; text-align:center; color:#999;">暂无持仓基金</div>';
            return;
        }
        
        // 串行获取每只基金的估算数据
        let currentIndex = 0;
        const results = [];
        
        function fetchNext() {
            if (currentIndex >= fundList.length) {
                // 全部完成，渲染结果
                loadingEl.style.display = 'none';
                renderEstimate(results);
                return;
            }
            
            const fund = fundList[currentIndex];
            currentIndex++;
            
            fetchEstimateDataFromTTFund(fund.code)
                .then(data => {
                    if (data.success) {
                        // 计算预估收益
                        const estimateNav = data.estimateNav;
                        const yesterdayNav = data.yesterdayNav;
                        const growthRate = parseFloat(data.growthRate) || 0;
                        const dailyProfit = fund.share * (estimateNav - yesterdayNav);
                        
                        results.push({
                            ...fund,
                            todayNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            dailyProfit: dailyProfit,
                            estimateTime: data.estimateTime
                        });
                    }
                })
                .catch(err => {
                    console.error(`获取 ${fund.code} 估算数据失败:`, err);
                })
                .finally(() => {
                    setTimeout(fetchNext, 300);
                });
        }
        
        fetchNext();
    }

    // 获取天天基金估算数据（独立的JSONP处理）
    function fetchEstimateDataFromTTFund(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const callbackName = 'ttfund_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            // 创建临时回调函数
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                cleanup();
                
                try {
                    if (data && data.fundcode) {
                        const estimateNav = parseFloat(data.gsz) || 0;
                        const yesterdayNav = parseFloat(data.dwjz) || 0;
                        const growthRate = data.gszzl || '0';
                        const estimateTime = data.gztime || '';
                        
                        resolve({
                            success: true,
                            code: code,
                            estimateNav: estimateNav,
                            yesterdayNav: yesterdayNav,
                            growthRate: growthRate,
                            estimateTime: estimateTime
                        });
                    } else {
                        reject(new Error('Invalid data'));
                    }
                } catch (e) {
                    reject(e);
                }
            };

            function cleanup() {
                delete window[callbackName];
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            // 劫持jsonpgz回调
            const originalJsonpgz = window.jsonpgz;
            window.jsonpgz = function(data) {
                window[callbackName](data);
                // 恢复原回调
                if (originalJsonpgz) {
                    window.jsonpgz = originalJsonpgz;
                }
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // 渲染实时预估
    function renderEstimate(results) {
        const contentEl = document.getElementById('estimateContent');
        
        // 按板块分组
        const sectorMap = {};
        results.forEach(item => {
            if (!sectorMap[item.sectorId]) {
                sectorMap[item.sectorId] = {
                    name: item.sectorName,
                    color: item.sectorColor,
                    funds: []
                };
            }
            sectorMap[item.sectorId].funds.push(item);
        });
        
        // 计算总收益
        let totalProfit = 0;
        let profitCount = 0;
        let lossCount = 0;
        
        results.forEach(item => {
            totalProfit += item.dailyProfit;
            if (item.dailyProfit > 0) profitCount++;
            else if (item.dailyProfit < 0) lossCount++;
        });
        
        // 更新顶部汇总
        const totalPnlEl = document.getElementById('totalEstimatePnl');
        totalPnlEl.textContent = (totalProfit >= 0 ? '+' : '') + totalProfit.toFixed(2);
        totalPnlEl.style.color = totalProfit >= 0 ? '#ff4d4f' : '#52c41a';
        document.getElementById('estimateProfitCount').textContent = profitCount;
        document.getElementById('estimateLossCount').textContent = lossCount;
        
        // 渲染各板块
        let html = '';
        const isMobile = window.innerWidth <= 768;
        
        // ✅ 修改：使用当前组合的板块
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        portfolio.sectors.forEach(sector => {
            const sectorData = sectorMap[sector.id];
            if (!sectorData || sectorData.funds.length === 0) return;
            
            // 计算板块总收益、持仓总额和收益率
            const sectorProfit = sectorData.funds.reduce((sum, f) => sum + f.dailyProfit, 0);
            let sectorTotalAsset = 0;
            let sectorTotalCost = 0;
            
            sectorData.funds.forEach(fund => {
                const marketValue = fund.share * fund.todayNav;
                const costValue = fund.share * fund.costNav;
                sectorTotalAsset += marketValue;
                sectorTotalCost += costValue;
            });
            
            const sectorHoldingProfit = sectorTotalAsset - sectorTotalCost;
            const sectorHoldingProfitRate = sectorTotalCost > 0 ? (sectorHoldingProfit / sectorTotalCost * 100) : 0;
            
            html += `
                <div class="pnl-sector" id="pnl-sector-${sector.id}" style="border-top-color: ${sectorData.color}">
                    <div class="pnl-sector-header" onclick="togglePnlSector('${sector.id}', event)" style="cursor: pointer;">
                        <div class="pnl-sector-name">
                            <span class="sector-collapse-icon" id="pnl-icon-${sector.id}">▼</span>
                            <span style="color:${sectorData.color}; font-size:20px;">●</span>
                            ${sectorData.name}
                        </div>
                        <div class="pnl-sector-stats">
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-total" style="color: ${sectorProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorProfit >= 0 ? '+' : ''}${sectorProfit.toFixed(2)}
                                </div>
                            </div>
                            <div class="pnl-sector-stat">
                                <div class="pnl-sector-asset">${Math.round(sectorTotalAsset).toLocaleString()}</div>
                                <div class="pnl-sector-rate" style="color: ${sectorHoldingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                    ${sectorHoldingProfitRate >= 0 ? '+' : ''}${sectorHoldingProfitRate.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pnl-sector-content" id="pnl-content-${sector.id}">
            `;
            
            if (isMobile) {
                // 手机端：使用新的卡片式布局
                html += `<div class="pnl-mobile-list">`;
                
                sectorData.funds.forEach(fund => {
                    const totalMarketValue = fund.share * fund.todayNav;
                    const holdingProfit = totalMarketValue - (fund.share * fund.costNav);
                    const holdingProfitRate = (holdingProfit / (fund.share * fund.costNav)) * 100;
                    
                    html += `
                        <div class="pnl-mobile-item">
                            <div class="pnl-mobile-header">
                                <div class="pnl-mobile-fund-info">
                                    <div class="pnl-mobile-fund-name">${fund.name}</div>
                                    <div class="pnl-mobile-fund-code">${fund.code}</div>
                                </div>
                            </div>
                            <div class="pnl-mobile-data">
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">日收益</div>
                                    <div class="pnl-mobile-value" style="color: ${fund.dailyProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${fund.growthRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">持仓收益</div>
                                    <div class="pnl-mobile-value" style="color: ${holdingProfit >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfit >= 0 ? '+' : ''}${holdingProfit.toFixed(2)}
                                    </div>
                                    <div class="pnl-mobile-sub" style="color: ${holdingProfitRate >= 0 ? '#ff4d4f' : '#52c41a'}">
                                        ${holdingProfitRate >= 0 ? '+' : ''}${holdingProfitRate.toFixed(2)}%
                                    </div>
                                </div>
                                <div class="pnl-mobile-col">
                                    <div class="pnl-mobile-label">总市值</div>
                                    <div class="pnl-mobile-value">${totalMarketValue.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`; // 关闭 pnl-mobile-list 和 pnl-sector-content
            } else {
                // PC端：保持原有表格布局
                html += `
                    <table class="pnl-table">
                        <thead>
                            <tr>
                                <th>基金代码</th>
                                <th>基金名称</th>
                                <th>估算净值</th>
                                <th>估算涨幅</th>
                                <th>持仓份额</th>
                                <th>预估收益</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sectorData.funds.forEach(fund => {
                    const growthClass = fund.growthRate > 0 ? 'growth-positive' : (fund.growthRate < 0 ? 'growth-negative' : 'growth-zero');
                    const profitClass = fund.dailyProfit > 0 ? 'profit-positive' : (fund.dailyProfit < 0 ? 'profit-negative' : 'profit-zero');
                    
                    html += `
                        <tr>
                            <td><span class="fund-code">${fund.code}</span></td>
                            <td><span class="fund-name">${fund.name}</span></td>
                            <td><span class="nav-value">${fund.todayNav.toFixed(4)}</span></td>
                            <td><span class="growth-rate ${growthClass}">${fund.growthRate >= 0 ? '+' : ''}${fund.growthRate.toFixed(2)}%</span></td>
                            <td><span class="share-amount">${fund.share.toLocaleString()}</span></td>
                            <td><span class="daily-profit ${profitClass}">${fund.dailyProfit >= 0 ? '+' : ''}${fund.dailyProfit.toFixed(2)}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            }
            
            html += `</div></div>`; // 关闭 pnl-sector-content 和 pnl-sector
        });
        
        contentEl.innerHTML = html;
        
        // 初始化板块折叠状态
        if (UIState.collapsedPnlSectors) {
            UIState.collapsedPnlSectors.forEach(sectorId => {
                const contentEl = document.getElementById(`pnl-content-${sectorId}`);
                const iconEl = document.getElementById(`pnl-icon-${sectorId}`);
                if (contentEl && iconEl) {
                    contentEl.style.display = 'none';
                    iconEl.textContent = '▶';
                }
            });
        }
    }

    // --- 核心计算：复利计算器 ---
    function calcCompound() {
        const principal = parseFloat(document.getElementById('cpPrincipal').value) || 0;
        const rate = parseFloat(document.getElementById('cpRate').value) / 100 || 0;
        const years = parseFloat(document.getElementById('cpYears').value) || 1;

        // 1. 一次性投入 (Lump Sum)
        // FV = P * (1+r)^n
        const finalLumpSum = principal * Math.pow((1 + rate), years);
        
        // 2. 定投 (DCA)
        // 目标是在 Years 年内，累计投入本金达到 principal
        // 每月需投入 = principal / (years * 12)
        const monthlyContrib = principal / (years * 12);
        const monthlyRate = rate / 12;
        let dcaBalance = 0;
        
        // 生成图表数据
        const labels = [];
        const dataLump = [];
        const dataDCA = [];
        
        let currentLump = principal;
        
        // 初始点 (第0年)
        labels.push('Start');
        dataLump.push(principal);
        dataDCA.push(0);

        // 按年迭代计算
        for (let y = 1; y <= years; y++) {
            // Lump Sum 增长
            currentLump = currentLump * (1 + rate);
            dataLump.push(currentLump);

            // DCA 增长 (按月复利累加 12次)
            for(let m=0; m<12; m++) {
                dcaBalance = (dcaBalance + monthlyContrib) * (1 + monthlyRate);
            }
            dataDCA.push(dcaBalance);
            labels.push(`Year ${y}`);
        }

        // 更新UI
        document.getElementById('resLumpSum').innerText = "¥" + Math.round(finalLumpSum).toLocaleString();
        document.getElementById('resDCA').innerText = "¥" + Math.round(dcaBalance).toLocaleString();
        document.getElementById('cpMonthlyInput').innerText = "¥" + Math.round(monthlyContrib).toLocaleString();

        // 绘制图表
        renderCompoundChart(labels, dataLump, dataDCA);
    }

    function renderCompoundChart(labels, dataA, dataB) {
        const ctx = document.getElementById('compoundChart').getContext('2d');
        
        if (compoundChart) {
            compoundChart.destroy(); // 销毁旧图表
        }

        compoundChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '一次性投入 (激进)',
                        data: dataA,
                        borderColor: '#faad14', // 橙色
                        backgroundColor: 'rgba(250, 173, 20, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: '定投积累 (稳健)',
                        data: dataB,
                        borderColor: '#1890ff', // 蓝色
                        backgroundColor: 'rgba(24, 144, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // --- 图表初始化 (再平衡) ---
    function initChart() {
        const ctx = document.getElementById('assetChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%', 
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true, 
                            padding: 15,
                            font: { size: 11 }
                        }
                    } 
                }
            }
        });
    }

    // --- 渲染逻辑 (定投部分) ---
    function renderApp() {
        // 获取当前组合
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        // 渲染组合选择器
        renderPortfolioSelector();

        const container = document.getElementById('sectors-container');
        container.innerHTML = ''; 

        // 遍历当前组合的板块
        portfolio.sectors.forEach(sector => {
            const sectorHTML = buildSectorHTML(sector);
            container.insertAdjacentHTML('beforeend', sectorHTML);
            
            const tbody = document.getElementById(`tbody-${sector.id}`);
            sector.funds.forEach(fund => {
                tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(sector.id, fund));
            });
        });

        reCalcView(); 
    }

    function buildSectorHTML(sector) {
        // 检查折叠状态
        const isCollapsed = UIState.isSectorCollapsed(sector.id);
        
        return `
        <div class="sector-card" id="${sector.id}" style="border-top-color: ${sector.color}">
            <div class="card-header collapsible" onclick="toggleSectorCollapse('${sector.id}', event)">
                <div class="header-left">
                    <div class="sector-collapse-icon" id="sector-icon-${sector.id}">
                        ${isCollapsed ? '▶' : '▼'}
                    </div>
                    <div class="tool-bar">
                        <input type="color" class="color-picker" value="${sector.color}" onchange="updateSectorColor('${sector.id}', this.value)" onclick="event.stopPropagation()" title="修改颜色">
                    </div>
                    <input type="text" class="sector-name-input" value="${sector.name}" onchange="updateSectorName('${sector.id}', this.value)" onclick="event.stopPropagation()">
                </div>
                <div class="header-right">
                    <span class="ratio-label">目标占比:</span>
                    <input type="number" class="ratio-input sec-weight" value="${sector.weight}" onchange="calcAll()" onclick="event.stopPropagation()"> %
                    <span class="progress-mini curr-ratio-text">(实际 0%)</span>
                    <button class="btn-icon" onclick="deleteSector('${sector.id}'); event.stopPropagation();" title="删除板块">×</button>
                </div>
            </div>
            <div class="table-wrap" id="sector-content-${sector.id}" style="display: ${isCollapsed ? 'none' : 'block'}">
                <table class="fund-table">
                    <thead>
                        <tr>
                            <th width="20%">基金名称</th>
                            <th width="12%">代码</th>
                            <th width="12%">份额</th>
                            <th width="10%">成本</th>
                            <th width="10%">净值</th>
                            <th width="15%">市值</th>
                            <th width="18%">盈亏</th>
                            <th width="3%"></th>
                        </tr>
                    </thead>
                    <tbody class="fund-list" id="tbody-${sector.id}"></tbody>
                </table>
            </div>
            <button class="btn-add-fund" onclick="addFundToSector('${sector.id}')" style="display: ${isCollapsed ? 'none' : 'block'}">+ 添加基金</button>
        </div>
        `;
    }

    function buildFundRowHTML(sectorId, fund) {
        return `
            <tr>
                <td><input type="text" class="tb-input f-name" value="${fund.name}" onchange="calcAll()"></td>
                <td><input type="text" class="tb-input f-code" value="${fund.code}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-share" value="${fund.share}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-cost" value="${fund.cost}" onchange="calcAll()"></td>
                <td><input type="number" class="tb-input f-nav" value="${fund.nav}" onchange="calcAll()"></td>
                <td>
                    <div class="val-display market-value">¥0</div>
                </td>
                <td>
                    <div class="val-display profit-value">¥0</div>
                    <div class="pf-sub profit-rate">--</div>
                </td>
                <td style="text-align:center"><button class="btn-icon" onclick="delRow(this)">×</button></td>
            </tr>
        `;
    }

    // --- 交互与计算 ---

    function createNewSector() {
        // ✅ 修改：添加到当前组合
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        const newId = 'sec_' + Date.now();
        const newSector = {
            id: newId, name: '新板块', color: '#999999', weight: 0,
            funds: [{ name: '新基金', code: '', share: 0, cost: 0, nav: 1.0 }]
        };
        portfolio.sectors.push(newSector);
        
        const container = document.getElementById('sectors-container');
        container.insertAdjacentHTML('beforeend', buildSectorHTML(newSector));
        const tbody = document.getElementById(`tbody-${newId}`);
        tbody.insertAdjacentHTML('beforeend', buildFundRowHTML(newId, newSector.funds[0]));
        
        saveToLocal();
    }

    function deleteSector(id) {
        if(!confirm('确定删除该板块吗？')) return;
        
        // 从当前组合删除
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        portfolio.sectors = portfolio.sectors.filter(s => s.id !== id);
        document.getElementById(id).remove();
        calcAll();
    }

    function addFundToSector(sectorId) {
        const emptyFund = { name: '', code: '', share: 0, cost: 0, nav: 1.0 };
        document.getElementById(`tbody-${sectorId}`).insertAdjacentHTML('beforeend', buildFundRowHTML(sectorId, emptyFund));
        calcAll();
    }

    function delRow(btn) {
        btn.closest('tr').remove();
        calcAll();
    }

    function updateSectorColor(id, color) {
        // ✅ 修改：更新当前组合的板块
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        const sector = portfolio.sectors.find(s => s.id === id);
        if(sector) sector.color = color;
        document.getElementById(id).style.borderTopColor = color;
        calcAll(); // 更新图表颜色
    }
    
    function updateSectorName(id, val) {
        // ✅ 修改：更新当前组合的板块
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        const sector = portfolio.sectors.find(s => s.id === id);
        if(sector) sector.name = val;
        calcAll(); // 更新表格名称
    }
    
    function calcAll() {
        // 获取当前组合
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;

        let currentTotalAsset = 0;
        let totalProfit = 0;
        
        const chartLabels = [];
        const chartData = [];
        const chartColors = [];
        const rebalanceData = [];

        // 遍历当前组合的板块
        portfolio.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if (!card) return;

            sector.weight = parseFloat(card.querySelector('.sec-weight').value) || 0;
            
            let sectorCurrentVal = 0;
            const newFundsList = [];

            const rows = card.querySelectorAll('.fund-list tr');
            rows.forEach(row => {
                const name = row.querySelector('.f-name').value;
                const code = row.querySelector('.f-code').value;
                const share = parseFloat(row.querySelector('.f-share').value) || 0;
                const cost = parseFloat(row.querySelector('.f-cost').value) || 0;
                const nav = parseFloat(row.querySelector('.f-nav').value) || 0;

                newFundsList.push({ name, code, share, cost, nav });

                const marketVal = share * nav;
                const profit = (nav - cost) * share;
                const profitRate = cost > 0 ? ((nav - cost) / cost * 100) : 0;

                currentTotalAsset += marketVal;
                totalProfit += profit;
                sectorCurrentVal += marketVal;

                // 更新行UI - 市值
                row.querySelector('.market-value').innerText = '¥' + Math.round(marketVal).toLocaleString();
                
                // 更新行UI - 盈亏
                const profitEl = row.querySelector('.profit-value');
                profitEl.innerText = (profit>=0?'+':'') + '¥' + Math.round(profit).toLocaleString();
                profitEl.className = 'val-display profit-value ' + (profit>=0 ? 'pf-pos' : 'pf-neg');
                
                const rateEl = row.querySelector('.profit-rate');
                rateEl.innerText = (profitRate>=0?'+':'') + profitRate.toFixed(2) + '%';
                rateEl.className = 'pf-sub profit-rate ' + (profitRate>=0 ? 'pf-pos' : 'pf-neg');
            });

            sector.funds = newFundsList;
            sector._tempCurrentVal = sectorCurrentVal;
            
            // 收集图表与再平衡数据
            chartLabels.push(sector.name);
            chartData.push(sectorCurrentVal);
            chartColors.push(sector.color);
            rebalanceData.push({
                name: sector.name,
                color: sector.color,
                currentVal: sectorCurrentVal,
                targetRate: sector.weight
            });
        });

        // 更新板块实际占比显示
        portfolio.sectors.forEach(sector => {
            const card = document.getElementById(sector.id);
            if(!card) return;

            const actualRate = currentTotalAsset > 0 ? (sector._tempCurrentVal / currentTotalAsset * 100) : 0;
            card.querySelector('.curr-ratio-text').innerText = `(实际 ${actualRate.toFixed(1)}%)`;
        });

        // 更新图表与再平衡表
        updateDashboard(chartLabels, chartData, chartColors, rebalanceData, currentTotalAsset);

        saveToLocal();
    }

    // --- 更新图表与再平衡表 ---
    function updateDashboard(labels, data, colors, rbData, totalAsset) {
        // 更新图表
        if (myChart) {
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = data;
            myChart.data.datasets[0].backgroundColor = colors;
            myChart.update();
        }

        // 更新再平衡表格
        const tbody = document.getElementById('rebalanceBody');
        tbody.innerHTML = '';
        
        rbData.forEach(item => {
            const actualRate = totalAsset > 0 ? (item.currentVal / totalAsset * 100) : 0;
            const diffRate = actualRate - item.targetRate;
            
            const targetVal = totalAsset * (item.targetRate / 100);
            const actionAmount = targetVal - item.currentVal; // 正数=需买入，负数=需卖出

            let statusHtml = '<span class="tag-status st-ok">达标</span>';
            let actionHtml = '-';

            // 阈值 2%
            if (diffRate > 2) {
                statusHtml = `<span class="tag-status st-over">超配 ${diffRate.toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-sell">卖出 ¥${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            } else if (diffRate < -2) {
                statusHtml = `<span class="tag-status st-under">低配 ${Math.abs(diffRate).toFixed(1)}%</span>`;
                actionHtml = `<span class="rb-action act-buy">买入 ¥${Math.round(Math.abs(actionAmount)).toLocaleString()}</span>`;
            }

            const tr = `
                <tr>
                    <td><span style="color:${item.color}; font-weight:bold; margin-right:5px;">●</span>${item.name}</td>
                    <td style="text-align:center; font-weight:bold;">${actualRate.toFixed(1)}%</td>
                    <td style="text-align:center; color:#999;">${item.targetRate}%</td>
                    <td style="text-align:center;">${statusHtml}</td>
                    <td style="text-align:right;">${actionHtml}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', tr);
        });
    }

    function reCalcView() { calcAll(); }

    function saveToLocal() {
        // 保存为V9格式（持仓管理系统）
        localStorage.setItem('smartSIP_data_v9', JSON.stringify(appData));
        // 只有在以下情况才自动保存到云端：
        // 1. 之前从云端加载过数据（hasCloudData = true）
        // 2. 用户手动操作（通过按钮保存）
        if (hasCloudData) {
            saveToCloud().catch(err => console.error('云端保存失败:', err));
        }
    }

    // --- 联网功能：同步基金实际净值（仅东方财富） ---
    function syncAllFundNav() {
        const statusEl = document.getElementById('syncStatus');
        statusEl.innerHTML = '<span class="sync-status sync-loading">🔄 正在同步净值数据...</span>';
        
        let totalFunds = 0;
        let successCount = 0;
        let errorCount = 0;
        const fundCodes = [];

        // ✅ 修改：从当前组合收集基金代码
        const portfolio = getCurrentPortfolio();
        if (!portfolio) {
            statusEl.innerHTML = '<span class="sync-status sync-error">⚠️ 没有可用的组合</span>';
            return;
        }
        
        // 收集所有基金代码
        portfolio.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code && fund.code.trim() !== '') {
                    totalFunds++;
                    fundCodes.push({ code: fund.code, sectorId: sector.id });
                }
            });
        });

        if (totalFunds === 0) {
            statusEl.innerHTML = '<span class="sync-status sync-error">⚠️ 没有找到有效的基金代码</span>';
            return;
        }

        // 串行请求，避免apidata冲突
        let currentIndex = 0;
        
        function fetchNext() {
            if (currentIndex >= fundCodes.length) {
                // 全部完成
                if (errorCount === 0) {
                    statusEl.innerHTML = `<span class="sync-status sync-success">✅ 成功同步 ${successCount} 只基金净值</span>`;
                } else {
                    statusEl.innerHTML = `<span class="sync-status sync-error">⚠️ 同步完成：成功 ${successCount} 只，失败 ${errorCount} 只</span>`;
                }
                setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                calcAll();
                return;
            }
            
            const item = fundCodes[currentIndex];
            currentIndex++;
            
            fetchActualNavFromEastmoney(item.code)
                .then(result => {
                    if (result.success) {
                        successCount++;
                        updateFundNavInUI(result.code, result.nav, result.time);
                    } else {
                        errorCount++;
                    }
                })
                .catch(() => {
                    errorCount++;
                })
                .finally(() => {
                    // 继续下一个
                    setTimeout(fetchNext, 300); // 延迟300ms避免请求过快
                });
        }
        
        fetchNext();
    }

    // 从东方财富获取实际净值
    function fetchActualNavFromEastmoney(code) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            const uniqueId = 'apidata_' + code + '_' + Date.now();
            
            const timeout = setTimeout(() => {
                cleanup();
                reject(new Error('Timeout'));
            }, 10000);

            function cleanup() {
                if (window[uniqueId]) {
                    delete window[uniqueId];
                }
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            }

            script.onload = function() {
                // 给一点时间让脚本执行
                setTimeout(() => {
                    try {
                        // 东方财富接口会设置全局变量 apidata
                        if (window.apidata && window.apidata.content) {
                            const html = window.apidata.content;
                            
                            // 立即保存到唯一变量，避免被覆盖
                            window[uniqueId] = JSON.parse(JSON.stringify(window.apidata));
                            
                            // 解析HTML表格
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');
                            
                            if (rows.length > 0) {
                                const firstRow = rows[0];
                                const cells = firstRow.querySelectorAll('td');
                                
                                if (cells.length >= 2) {
                                    const date = cells[0].textContent.trim();
                                    const nav = parseFloat(cells[1].textContent.trim()) || 0;
                                    
                                    clearTimeout(timeout);
                                    cleanup();
                                    resolve({
                                        success: true,
                                        code: code,
                                        nav: nav,
                                        time: date
                                    });
                                    return;
                                }
                            }
                        }
                        clearTimeout(timeout);
                        cleanup();
                        reject(new Error('No data'));
                    } catch (e) {
                        clearTimeout(timeout);
                        cleanup();
                        reject(e);
                    }
                }, 200);
            };

            script.onerror = () => {
                clearTimeout(timeout);
                cleanup();
                reject(new Error('Network error'));
            };

            script.src = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${code}&page=1&per=1&_=${Date.now()}`;
            document.head.appendChild(script);
        });
    }

    // 更新UI中的净值
    function updateFundNavInUI(code, nav, time) {
        // ✅ 修改：更新当前组合的数据
        const portfolio = getCurrentPortfolio();
        if (!portfolio) return;
        
        portfolio.sectors.forEach(sector => {
            sector.funds.forEach(fund => {
                if (fund.code === code) {
                    fund.nav = nav;
                }
            });
        });

        // 更新UI输入框
        document.querySelectorAll('.f-code').forEach(input => {
            if (input.value === code) {
                const row = input.closest('tr');
                const navInput = row.querySelector('.f-nav');
                navInput.value = nav.toFixed(4);
                navInput.style.color = '#52c41a'; // 绿色表示实际净值
                navInput.title = `实际净值 (${time})`;
            }
        });

        saveToLocal();
    }

    function exportData() {
        const str = localStorage.getItem('smartSIP_data_v7');
        if (!str) return alert("无数据");
        const blob = new Blob([str], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `投资策略V7_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importData(input) {
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.sectors) throw new Error();
                appData = json;
                saveToLocal();
                renderApp();
                alert("配置已恢复");
            } catch(e){ alert("文件格式错误"); }
        };
        r.readAsText(f);
        input.value = '';
    }
    
    // 全局函数：移除所有点击高亮效果
    function removeAllTapHighlights() {
        // 移除所有 pnl-sector-header 的点击高亮
        document.querySelectorAll('.pnl-sector-header, .pnl-sector-header *').forEach(el => {
            el.style.webkitTapHighlightColor = 'transparent';
            el.style.webkitTouchCallout = 'none';
            el.style.userSelect = 'none';
        });
    }
    
    // 在页面加载后和每次渲染后调用
    if (typeof MutationObserver !== 'undefined') {
        const observer = new MutationObserver(() => {
            removeAllTapHighlights();
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // 立即执行一次
    removeAllTapHighlights();
</script>

</body>
</html>